# XTools 常见错误检查清单

> 基于 Git 提交历史总结的高频错误模式,用于代码提交前快速自查

**最后更新**: 2025-12-11 | **统计范围**: 最近 100 次提交

---

## 📋 提交前必查项

### ✅ 模块架构检查 (9 次历史错误)

| 检查项 | 说明 | 历史错误 |
|--------|------|---------|
| **K2Node 位置** | K2Node 必须在 UncookedOnly 模块,不能在 Runtime 模块 | `修复UHT在非编辑器构建时仍解析K2Node头文件的问题` |
| **模块类型配置** | UncookedOnly 模块在 .uplugin 中类型必须为 "UncookedOnly" | `修复PointSamplingEditor模块类型配置` |
| **K2Node 文件完整性** | 确保所有 K2Node 相关文件都已添加 | `修复遗漏的K2Node_PointSamplingPinManager.h文件` |

**快速检查命令**:
```powershell
# 检查 Runtime 模块中是否有 K2Node
Get-ChildItem Source\*Runtime,Source\Sort,Source\XToolsCore -Recurse -Filter "K2Node*.h"
# 应该返回空结果
```

---

### ✅ WITH_EDITOR 宏检查 (5 次历史错误)

| 检查项 | 说明 | 历史错误 |
|--------|------|---------|
| **宏配对** | `#if WITH_EDITOR` 必须有对应的 `#endif` | `修复TextureSamplingHelper.cpp中#if WITH_EDITOR预处理指令不匹配问题` |
| **编辑器类型保护** | `TextureCompressionSettings`, `FAssetData` 等必须在 WITH_EDITOR 内 | `修复TextureSamplingHelper中TextureCompressionSettings的使用` |
| **头文件包含** | 编辑器专用头文件必须在 WITH_EDITOR 内包含 | `修复更多编辑器专用代码在非编辑器构建时的错误` |

**常见编辑器专用类型**:
```cpp
// ❌ 错误 - 未保护
#include "AssetRegistry/AssetData.h"
FAssetData AssetData;

// ✅ 正确
#if WITH_EDITOR
#include "AssetRegistry/AssetData.h"
#endif

void MyFunction() {
#if WITH_EDITOR
    FAssetData AssetData;
#endif
}
```

---

### ✅ 跨版本兼容性检查 (6 次历史错误)

| UE 版本 | 常见问题 | 解决方案 | 历史错误 |
|---------|---------|---------|---------|
| **5.6-5.7** | `FVector2D` → `FVector2f` | 使用 `UE_REAL_TO_FLOAT()` 或条件编译 | `修复 UE 5.6-5.7 版本 FVector2D/FVector2f 类型转换问题` |
| **5.4+** | `FCompression` API 变更 | 检查 `GetMaximumCompressedSize` 参数 | `修复UE 5.4版本FCompression API兼容性问题` |
| **5.4+** | `AssetSearch` 模块依赖 | 使用条件编译 `#if ENGINE_MAJOR_VERSION == 5 && ENGINE_MINOR_VERSION >= 4` | `AssetSearch模块依赖改为UE5.4+条件编译` |
| **5.7+** | 函数签名变更 | 检查 `DrawGraphEditor` 等函数签名 | `修复DrawGraphEditor函数签名不匹配导致的编译错误` |

**快速检查**:
```cpp
// 检查是否使用了版本敏感的类型
grep -r "FVector2D" Source/  # 在 5.6+ 中可能需要改为 FVector2f
grep -r "FCompression::" Source/  # 检查 API 使用
```

---

### ✅ 构建配置测试 (必须)

| 配置 | 必须测试 | 说明 |
|------|---------|------|
| **Development Editor** | ✅ | 编辑器模式,最常用 |
| **Development Game** | ✅ | 游戏模式,无编辑器代码 |
| **Shipping** | 可选 | 发布模式 |

**历史教训**: `修复Game构建编译错误: 添加PixelFormat.h头文件, 统一WITH_EDITOR宏使用`

**手动测试方法**:
```powershell
# 使用 UE 的 UnrealBuildTool 测试不同配置
# Development Editor
<UE_ROOT>\Engine\Build\BatchFiles\Build.bat <ProjectName>Editor Win64 Development -Project="<ProjectPath>.uproject"

# Development Game
<UE_ROOT>\Engine\Build\BatchFiles\Build.bat <ProjectName> Win64 Development -Project="<ProjectPath>.uproject"
```

---

## 🐛 常见代码错误

### 1. 空指针访问

**历史错误**: `修复空指针访问和材质函数连接问题`

**检查点**:
```cpp
// ❌ 危险
MaterialFunction->DoSomething();

// ✅ 安全
if (MaterialFunction && MaterialFunction->IsValidLowLevel()) {
    MaterialFunction->DoSomething();
}
```

---

### 2. 委托生命周期问题

**历史错误**: `修复资产重命名委托的生命周期和竞态条件问题`

**检查点**:
- 委托绑定的对象是否可能被销毁?
- 是否需要使用 `TWeakObjectPtr`?
- 是否在对象销毁前解绑委托?

```cpp
// ❌ 危险 - 对象可能已销毁
OnAssetRenamed.AddUObject(this, &UMyClass::HandleRename);

// ✅ 安全 - 使用弱引用
OnAssetRenamed.AddWeakLambda(this, [WeakThis = TWeakObjectPtr<UMyClass>(this)]() {
    if (WeakThis.IsValid()) {
        WeakThis->HandleRename();
    }
});
```

---

### 3. 首次 Tick 初始值问题

**历史错误**: `修复首次tick时初始值触发问题`

**检查点**:
- 是否在 `BeginPlay` 中正确初始化?
- 首次 Tick 是否会触发意外的回调?
- 是否需要跳过首次 Tick?

```cpp
// ✅ 正确处理首次 Tick
bool bIsFirstTick = true;

void Tick(float DeltaTime) {
    if (bIsFirstTick) {
        bIsFirstTick = false;
        return;  // 跳过首次 Tick
    }
    // 正常逻辑
}
```

---

### 4. Error 导致断言崩溃

**历史错误**: `替换Error为Warning避免断言崩溃并优化循环节点实现`

**检查点**:
- K2Node 中使用 `CompilerContext.MessageLog.Warning()` 而不是 `Error()`
- 除非是致命错误,否则使用 Warning

```cpp
// ❌ 会导致断言崩溃
CompilerContext.MessageLog.Error(*LOCTEXT("Error", "错误").ToString());

// ✅ 使用 Warning
CompilerContext.MessageLog.Warning(*LOCTEXT("Warning", "警告").ToString());
```

---

## 🔧 模块依赖检查

### Runtime 模块禁止依赖

```cs
// ❌ Runtime 模块的 .Build.cs 中禁止出现:
PublicDependencyModuleNames.AddRange(new string[] {
    "UnrealEd",           // 编辑器核心
    "BlueprintGraph",     // 蓝图图表
    "KismetCompiler",     // 蓝图编译器
    "Kismet",             // 蓝图运行时编辑器
    "AssetRegistry",      // 资产注册表 (编辑器)
});
```

### UncookedOnly 模块必须依赖

```cs
// ✅ UncookedOnly 模块必须包含:
PublicDependencyModuleNames.AddRange(new string[] {
    "Core",
    "CoreUObject",
    "Engine",
    "BlueprintGraph",     // K2Node 需要
    "KismetCompiler",     // 编译需要
    "<对应的Runtime模块>", // 例如: "PointSampling"
});
```

---

## 📊 错误频率统计

| 错误类型 | 出现次数 | 占比 | 状态 |
|---------|---------|------|------|
| 模块架构问题 | 9 | 36% | ✅ 已解决 |
| WITH_EDITOR 宏 | 5 | 20% | ⚠️ 需注意 |
| 跨版本兼容性 | 6 | 24% | ⚠️ 需注意 |
| 空指针/生命周期 | 3 | 12% | ⚠️ 需注意 |
| 其他 | 2 | 8% | - |

**总计**: 25 次修复提交 (最近 100 次提交中)

---

## ✅ 已解决的问题

### PointSampling 模块架构问题 (2025-12-11)

**问题**: K2Node_PointSampling 导致 9 次修复提交
- K2Node 放置在 Runtime 模块
- UHT 解析错误
- 模块类型配置错误

**解决方案**: 直接移除 PointSamplingEditor 模块
- 删除 `Source/PointSamplingEditor/` 目录
- 从 `XTools.uplugin` 移除模块配置
- 使用 `UFormationSamplingLibrary` 的 14 个独立函数

**效果**:
- ✅ 完全移除 K2Node 架构复杂度
- ✅ 简化插件结构(19 个模块 → 18 个模块)
- ✅ 避免未来类似的 K2Node 架构问题
- ✅ 降低维护成本

---

## 🚀 提交前检查流程

### 1. 手动检查清单

- [ ] 如果修改了模块架构,是否测试了 Game 构建?
- [ ] 如果使用了编辑器类型,是否添加了 WITH_EDITOR 保护?
- [ ] 如果修改了跨版本代码,是否测试了目标 UE 版本?
- [ ] 如果添加了委托,是否考虑了生命周期问题?
- [ ] 如果修改了 K2Node,是否使用 Warning 而不是 Error?

### 2. 提交信息格式

```
<type>(<scope>): <description>

类型:
- feat: 新功能
- fix: Bug 修复
- refactor: 重构
- docs: 文档

示例:
fix(PointSampling): 修复 K2Node 在 Runtime 模块中的问题
```

---

## 📚 相关文档

- `CLAUDE.md` - 项目开发指南
- `Docs/UE K2Node 开发指南.md` - K2Node 开发详解

---

## 🔄 文档维护

**更新频率**: 每发现新的高频错误模式时更新

**维护方式**:
```powershell
# 分析最近的修复提交
git log --oneline -50 --grep="修复\|fix" --format="%s"

# 更新此文档
```

**负责人**: 全体开发者
**最后更新**: 2025-12-11
