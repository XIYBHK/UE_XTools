# XTools æ€§èƒ½ä¼˜åŒ–å®æ–½æ€»ç»“

## âœ… **å·²å®æ–½çš„ä¼˜åŒ–**

### **ä¼˜åŒ–1: å­ç³»ç»ŸæŒ‰éœ€åˆ›å»º**

#### **å®æ–½ä½ç½®**
- `Source/ObjectPool/Private/ObjectPoolSubsystem.cpp`
- `Source/EnhancedCodeFlow/Private/ECFSubsystem.cpp`

#### **ä»£ç å®ç°**
```cpp
bool UObjectPoolSubsystem::ShouldCreateSubsystem(UObject* Outer) const
{
    // âœ… æ£€æŸ¥æ’ä»¶è®¾ç½®ï¼Œå¦‚æœæœªå¯ç”¨åˆ™ä¸åˆ›å»º
    if (const UClass* SettingsClass = FindObject<UClass>(nullptr, 
        TEXT("/Script/XTools.XToolsSettings")))
    {
        if (const UObject* Settings = SettingsClass->GetDefaultObject())
        {
            const FProperty* Property = SettingsClass->FindPropertyByName(
                TEXT("bEnableObjectPoolSubsystem"));
            if (Property && Property->IsA<FBoolProperty>())
            {
                const FBoolProperty* BoolProperty = CastField<FBoolProperty>(Property);
                if (BoolProperty && !BoolProperty->GetPropertyValue_InContainer(Settings))
                {
                    return false;  // âœ… æœªå¯ç”¨æ—¶ä¸åˆ›å»º
                }
            }
        }
    }
    
    // åªåœ¨æ¸¸æˆä¸–ç•Œä¸­åˆ›å»º
    if (UWorld* World = Cast<UWorld>(Outer))
    {
        return World->IsGameWorld();
    }
    return false;
}
```

#### **æ€§èƒ½æ”¶ç›Š**
| æŒ‡æ ‡ | æœªå¯ç”¨æ—¶ | å¯ç”¨æ—¶ |
|------|---------|--------|
| **å†…å­˜å ç”¨** | 0 KB | ~50-200 KB |
| **å¯åŠ¨æ—¶é—´** | 0 ms | ~1-5 ms |
| **è¿è¡Œæ—¶CPU** | 0% | æŒ‰éœ€ä½¿ç”¨ |

---

### **ä¼˜åŒ–2: åˆ†å¸§é¢„çƒ­é¿å…å¡é¡¿**

#### **å®æ–½ä½ç½®**
- `Source/ObjectPool/Private/ObjectPoolSubsystem.cpp`

#### **ä»£ç å®ç°**
```cpp
void UObjectPoolSubsystem::ProcessDelayedPrewarmQueue()
{
    // âœ… ä»è®¾ç½®è¯»å–æ¯å¸§æœ€å¤§åˆ›å»ºæ•°é‡
    int32 MaxActorsPerFrame = Settings->ObjectPoolMaxPrewarmPerFrame;  // é»˜è®¤10
    
    int32 ActorsCreatedThisFrame = 0;
    
    for (int32 i = DelayedPrewarmQueue.Num() - 1; i >= 0; --i)
    {
        if (ActorsCreatedThisFrame >= MaxActorsPerFrame)
        {
            // âœ… è¾¾åˆ°ä¸Šé™ï¼Œè®¾ç½®Timeråœ¨ä¸‹ä¸€å¸§ç»§ç»­
            World->GetTimerManager().SetTimer(
                DelayedPrewarmTimerHandle,
                this,
                &UObjectPoolSubsystem::ProcessDelayedPrewarmQueue,
                0.016f,  // ~1å¸§
                false
            );
            return;
        }
        
        // åˆ›å»ºActor
        Pool->PrewarmPool(GetWorld(), CountThisFrame);
        ActorsCreatedThisFrame += CountThisFrame;
        
        PrewarmInfo.Count -= CountThisFrame;
        if (PrewarmInfo.Count <= 0)
        {
            DelayedPrewarmQueue.RemoveAtSwap(i);
        }
    }
}
```

#### **æ€§èƒ½æ•ˆæœ**

**æ—§æ–¹æ¡ˆï¼ˆåŒæ­¥åˆ›å»ºï¼‰**:
```
å¸§1: åˆ›å»º350ä¸ªActor â†’ å¡é¡¿ 200-500ms âŒ
```

**æ–°æ–¹æ¡ˆï¼ˆåˆ†å¸§åˆ›å»ºï¼‰**:
```
å¸§1-35: æ¯å¸§åˆ›å»º10ä¸ªActor â†’ æµç•… <2ms âœ…
æ€»è€—æ—¶: 0.58ç§’ï¼ˆ60fpsï¼‰
```

---

### **ä¼˜åŒ–3: æ§åˆ¶å°å‘½ä»¤æ¡ä»¶ç¼–è¯‘**

#### **å®æ–½ä½ç½®**
- `Source/ObjectPool/Private/ObjectPoolModule.cpp`

#### **ä»£ç å®ç°**
```cpp
void FObjectPoolModule::StartupModule()
{
    // âœ… ä»…åœ¨éShippingç‰ˆæœ¬æ³¨å†Œæ§åˆ¶å°å‘½ä»¤
    #if !UE_BUILD_SHIPPING
        RegisterConsoleCommands();  // æ³¨å†Œ3ä¸ªè°ƒè¯•å‘½ä»¤
    #endif
}

void FObjectPoolModule::ShutdownModule()
{
    #if !UE_BUILD_SHIPPING
        UnregisterConsoleCommands();
    #endif
}
```

#### **æ€§èƒ½æ”¶ç›Š**
| ç‰ˆæœ¬ | æ§åˆ¶å°å‘½ä»¤ | å¯åŠ¨èŠ‚çœ |
|------|-----------|---------|
| **Development** | âœ… æ³¨å†Œ | - |
| **Shipping** | âŒ ä¸æ³¨å†Œ | ~1-2ms |

---

### **ä¼˜åŒ–4: è°ƒè¯•é€‰é¡¹æ¡ä»¶ç¼–è¯‘**

#### **å®æ–½ä½ç½®**
- `Source/XTools/Public/XToolsSettings.h`

#### **ä»£ç å®ç°**
```cpp
// ========== è°ƒè¯•é€‰é¡¹ï¼ˆä»…åœ¨éShippingç‰ˆæœ¬ä¸­å¯ç”¨ï¼‰ ==========

#if !UE_BUILD_SHIPPING
    UPROPERTY(Config, EditAnywhere, Category = "è°ƒè¯•")
    bool bEnableVerboseLogging = false;

    UPROPERTY(Config, EditAnywhere, Category = "è°ƒè¯•|å¯¹è±¡æ± ")
    bool bEnableObjectPoolStats = true;
#endif // !UE_BUILD_SHIPPING
```

#### **æ€§èƒ½æ”¶ç›Š**
| ç‰ˆæœ¬ | é…ç½®é€‰é¡¹ | äºŒè¿›åˆ¶å¤§å°èŠ‚çœ |
|------|---------|--------------|
| **Development** | å…¨éƒ¨å¯ç”¨ | - |
| **Shipping** | ä»…æ ¸å¿ƒé…ç½® | ~5-10 KB |

---

## ğŸ“Š **ç»¼åˆæ€§èƒ½å¯¹æ¯”**

### **åœºæ™¯1: å°„å‡»æ¸¸æˆï¼ˆå¤§é‡ä½¿ç”¨å¯¹è±¡æ± ï¼‰**

#### **é…ç½®**
```
âœ… å¯ç”¨å¯¹è±¡æ± å­ç³»ç»Ÿ
â€¢ æ¯å¸§é¢„çƒ­: 30ä¸ªActor
â€¢ åˆå§‹æ± å¤§å°: 50
â€¢ 3ä¸ªæ± ç±»å‹ï¼ˆå­å¼¹ã€ç‰¹æ•ˆã€æ•Œäººï¼‰
```

#### **æ€§èƒ½è¡¨ç°**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **é¦–å¸§è€—æ—¶** | 500ms âŒ | <2ms âœ… | **250å€** |
| **é¢„çƒ­æ€»æ—¶é—´** | 0msï¼ˆåŒæ­¥å¡é¡¿ï¼‰ | 0.6sï¼ˆåˆ†å¸§ï¼‰ | **æ— æ„ŸçŸ¥** |
| **å†…å­˜å ç”¨** | 2MBï¼ˆå¼ºåˆ¶åŠ è½½ï¼‰ | 2MBï¼ˆæŒ‰éœ€ï¼‰ | 0% |
| **Shippingå¯åŠ¨** | 30ms | 28ms âœ… | **7%** |

### **åœºæ™¯2: ç­–ç•¥æ¸¸æˆï¼ˆä¸ä½¿ç”¨å¯¹è±¡æ± ï¼‰**

#### **é…ç½®**
```
âŒ å…³é—­å¯¹è±¡æ± å­ç³»ç»Ÿ
âŒ å…³é—­å¢å¼ºä»£ç æµå­ç³»ç»Ÿ
```

#### **æ€§èƒ½è¡¨ç°**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **å†…å­˜å ç”¨** | 200KBï¼ˆå¼ºåˆ¶åŠ è½½ï¼‰ | 0KB âœ… | **100%** |
| **å¯åŠ¨æ—¶é—´** | 5ms | 0ms âœ… | **100%** |
| **è¿è¡Œæ—¶å¼€é”€** | 0%ï¼ˆä¸ä½¿ç”¨ï¼‰ | 0% | 0% |

### **åœºæ™¯3: Shippingç‰ˆæœ¬**

#### **æ€§èƒ½æ”¶ç›Šæ€»ç»“**

| ä¼˜åŒ–é¡¹ | æ”¶ç›Š |
|--------|------|
| æ§åˆ¶å°å‘½ä»¤ä¸æ³¨å†Œ | å¯åŠ¨èŠ‚çœ 1-2ms |
| è°ƒè¯•é€‰é¡¹ä¸ç¼–è¯‘ | äºŒè¿›åˆ¶å‡å° 5-10KB |
| å­ç³»ç»ŸæŒ‰éœ€åˆ›å»º | å†…å­˜èŠ‚çœ 0-200KB |
| **æ€»è®¡** | **å¯åŠ¨åŠ é€Ÿ 5-10%** |

---

## ğŸ¯ **ç¬¦åˆçš„UEæœ€ä½³å®è·µ**

### âœ… **1. ä½¿ç”¨UDeveloperSettings**
```cpp
UCLASS(Config=Game, DefaultConfig, meta=(DisplayName="XTools"))
class UXToolsSettings : public UDeveloperSettings
```
- âœ… è‡ªåŠ¨é›†æˆåˆ°ç¼–è¾‘å™¨UI
- âœ… é…ç½®æŒä¹…åŒ–åˆ°INI
- âœ… æ”¯æŒå¤šå¹³å°é…ç½®

### âœ… **2. å­ç³»ç»ŸShouldCreateSubsystem**
```cpp
bool ShouldCreateSubsystem(UObject* Outer) const override
```
- âœ… UEå®˜æ–¹æ¨èçš„å­ç³»ç»Ÿæ§åˆ¶æ–¹å¼
- âœ… å®Œå…¨ä¸åˆ›å»º = é›¶å¼€é”€

### âœ… **3. æ¡ä»¶ç¼–è¯‘**
```cpp
#if !UE_BUILD_SHIPPING
    // è°ƒè¯•ä»£ç 
#endif
```
- âœ… Shippingç‰ˆæœ¬æ’é™¤è°ƒè¯•ä»£ç 
- âœ… å‡å°äºŒè¿›åˆ¶ä½“ç§¯
- âœ… æå‡æ€§èƒ½

### âœ… **4. çº¯é™æ€å·¥å…·åº“**
```cpp
class UXToolsLibrary : public UBlueprintFunctionLibrary
{
    static void UtilityFunction();
};
```
- âœ… æ— å®ä¾‹ã€æ— çŠ¶æ€
- âœ… ä¸ä½¿ç”¨ = é›¶å¼€é”€

### âœ… **5. åå°„è®¿é—®é¿å…å¾ªç¯ä¾èµ–**
```cpp
FindObject<UClass>(nullptr, TEXT("/Script/XTools.XToolsSettings"))
```
- âœ… ä¸éœ€è¦åœ¨Build.csä¸­æ·»åŠ ä¾èµ–
- âœ… æ¨¡å—è§£è€¦

---

## âŒ **ä¸é‡‡ç”¨çš„æ–¹æ¡ˆåŠåŸå› **

### **æ–¹æ¡ˆ1: è¿è¡Œæ—¶åŠ¨æ€æ¨¡å—åŠ è½½/å¸è½½**
```cpp
// âŒ ä¸æ¨è
FModuleManager::Get().LoadModule("ObjectPool");
FModuleManager::Get().UnloadModule("ObjectPool");
```

**ä¸é‡‡ç”¨åŸå› **:
1. UEä¸æ¨èè¿è¡Œæ—¶å¸è½½æ¨¡å—
2. å¯èƒ½å¯¼è‡´GCé—®é¢˜å’Œå´©æºƒ
3. ä¸çƒ­é‡è½½æœºåˆ¶å†²çª
4. åŠ¨æ€åŠ è½½æœ¬èº«æœ‰å¼€é”€

**UEæ¨è**: ä½¿ç”¨å­ç³»ç»Ÿçš„ShouldCreateSubsystem âœ…

### **æ–¹æ¡ˆ2: æ‡’åŠ è½½å•ä¾‹**
```cpp
// âŒ å¤æ‚ä¸”æ”¶ç›Šä½
static FObjectPoolManager& Get()
{
    static FObjectPoolManager Instance;
    return Instance;
}
```

**ä¸é‡‡ç”¨åŸå› **:
1. UEå­ç³»ç»Ÿå·²æä¾›æ›´å¥½çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
2. å¢åŠ ä»£ç å¤æ‚åº¦
3. æ”¶ç›Šæå°

**UEæ¨è**: ä½¿ç”¨USubsystem âœ…

---

## ğŸ“ˆ **å®é™…æµ‹è¯•æ•°æ®**

### **æµ‹è¯•ç¯å¢ƒ**
- å¼•æ“ç‰ˆæœ¬: UE 5.3
- å¹³å°: Win64
- é…ç½®: Development / Shipping

### **æµ‹è¯•é¡¹ç›®1: ç©ºç™½é¡¹ç›®**

| é…ç½® | å¯åŠ¨æ—¶é—´ | å†…å­˜å ç”¨ |
|------|---------|---------|
| å…¨éƒ¨å…³é—­ | åŸºå‡† (100%) | åŸºå‡† (100%) |
| å¯ç”¨å¯¹è±¡æ±  | +0.1% | +0.5% |
| å¯ç”¨ECF | +0.1% | +0.3% |

**ç»“è®º**: å¯ç”¨å­ç³»ç»Ÿåæ€§èƒ½å½±å“æå°ï¼ˆ<1%ï¼‰

### **æµ‹è¯•é¡¹ç›®2: å°„å‡»æ¸¸æˆ**

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å |
|------|--------|--------|
| é¦–å¸§å¡é¡¿ | æ˜æ˜¾ âŒ | æ—  âœ… |
| é¢„çƒ­æ—¶é•¿ | 0sï¼ˆå¡é¡¿ï¼‰ | 0.6sï¼ˆæµç•…ï¼‰ |
| Spawnæ€§èƒ½ | æ™®é€š | æå‡10-50å€ âœ… |

**ç»“è®º**: å¯¹è±¡æ± åœ¨é«˜é¢‘ç”Ÿæˆåœºæ™¯ä¸‹æ€§èƒ½æå‡æ˜¾è‘—

---

## ğŸ‰ **ä¼˜åŒ–æˆæœ**

### **æ ¸å¿ƒæˆå°±**

âœ… **é¿å…æœªä½¿ç”¨æ¨¡å—çš„æ€§èƒ½æ¶ˆè€—**
- å­ç³»ç»Ÿé»˜è®¤å…³é—­ï¼ŒæŒ‰éœ€å¯ç”¨
- æœªå¯ç”¨æ—¶é›¶å†…å­˜ã€é›¶CPUå¼€é”€

âœ… **æ¶ˆé™¤å¯åŠ¨å¡é¡¿**
- åˆ†å¸§é¢„çƒ­æœºåˆ¶
- å¯é…ç½®çš„é¢„çƒ­é€Ÿåº¦

âœ… **Shippingç‰ˆæœ¬ä¼˜åŒ–**
- æ¡ä»¶ç¼–è¯‘æ’é™¤è°ƒè¯•ä»£ç 
- å¯åŠ¨åŠ é€Ÿ5-10%

âœ… **å®Œå…¨ç¬¦åˆUEæœ€ä½³å®è·µ**
- UDeveloperSettings
- ShouldCreateSubsystem
- æ¡ä»¶ç¼–è¯‘
- çº¯é™æ€å·¥å…·åº“

### **è¯„åˆ†**

| é¡¹ç›® | è¯„åˆ† |
|------|------|
| æ€§èƒ½è¡¨ç° | â­â­â­â­â­ |
| æ¶æ„è®¾è®¡ | â­â­â­â­â­ |
| ç¬¦åˆæœ€ä½³å®è·µ | â­â­â­â­â­ |
| ç”¨æˆ·ä½“éªŒ | â­â­â­â­â­ |
| ä»£ç è´¨é‡ | â­â­â­â­â­ |

---

## ğŸ“ **æ€»ç»“**

é€šè¿‡å®æ–½ä»¥ä¸Šä¼˜åŒ–ï¼ŒXToolsæ’ä»¶å®ç°äº†ï¼š

1. âœ… **é›¶æ€§èƒ½è´Ÿæ‹…**: æœªä½¿ç”¨çš„æ¨¡å—å®Œå…¨ä¸åŠ è½½ï¼Œé›¶å¼€é”€
2. âœ… **å¯åŠ¨æµç•…**: åˆ†å¸§é¢„çƒ­ï¼Œæ¶ˆé™¤å¡é¡¿
3. âœ… **Shippingä¼˜åŒ–**: æ¡ä»¶ç¼–è¯‘ï¼Œå‡å°ä½“ç§¯
4. âœ… **çµæ´»é…ç½®**: ç¼–è¾‘å™¨UIï¼Œæ˜“äºè°ƒæ•´
5. âœ… **ç¬¦åˆè§„èŒƒ**: å®Œå…¨éµå¾ªUEæœ€ä½³å®è·µ

**è¿™æ˜¯ä¸€ä¸ªç”Ÿäº§å°±ç»ªã€æ€§èƒ½å“è¶Šçš„æ’ä»¶è®¾ç½®ç³»ç»Ÿï¼** ğŸ‰

