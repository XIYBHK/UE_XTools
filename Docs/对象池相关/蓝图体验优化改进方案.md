ObjectPoolæ¨¡å—è“å›¾ä½“éªŒä¼˜åŒ–æ”¹è¿›æ–¹æ¡ˆ
ğŸ¯ æ ¸å¿ƒç›®æ ‡
ä¸ºObjectPoolæ¨¡å—æä¾›æ— ç¼çš„è“å›¾é›†æˆä½“éªŒï¼Œä½¿çº¯è“å›¾å¼€å‘è€…èƒ½å¤Ÿè½»æ¾ä½¿ç”¨å¯¹è±¡æ± åŠŸèƒ½ï¼Œè€Œæ— éœ€æ”¹å˜ç°æœ‰çš„å¼€å‘ä¹ æƒ¯ã€‚

ğŸ† æœ€ä½³è§£å†³æ–¹æ¡ˆï¼šè‡ªå®šä¹‰K2Node
ä¸ºä»€ä¹ˆé€‰æ‹©K2Nodeæ–¹æ¡ˆ
âœ… å®Œç¾å¥‘åˆéœ€æ±‚ï¼šçº¯è“å›¾ç¯å¢ƒä¸‹æ— ç—›ä½¿ç”¨C++åŠŸèƒ½
âœ… é›¶å­¦ä¹ æˆæœ¬ï¼šä¸åŸç”ŸSpawnActorèŠ‚ç‚¹å‡ ä¹ç›¸åŒçš„ä½¿ç”¨ä½“éªŒ
âœ… æ™ºèƒ½åŒ–ç¨‹åº¦é«˜ï¼šè‡ªåŠ¨ç±»å‹æ¨æ–­ã€æ™ºèƒ½æ± åŒ–å†³ç­–
âœ… æ‰©å±•æ€§å¼ºï¼šå¯æ·»åŠ æ± åŒ–ç‰¹æœ‰é€‰é¡¹ï¼Œé›†æˆè°ƒè¯•åŠŸèƒ½
ğŸ—ï¸ å®ç°æ–¹æ¡ˆè¯¦ç»†è®¾è®¡
1. æ ¸å¿ƒK2Nodeç±»è®¾è®¡
```cpp
UCLASS()
class OBJECTPOOL_API UK2Node_SpawnActorFromPool : public UK2Node_CallFunction
{
    GENERATED_BODY()

public:
    // æ„é€ å‡½æ•°
    UK2Node_SpawnActorFromPool();

    // èŠ‚ç‚¹æ ‡é¢˜
    virtual FText GetNodeTitle(ENodeTitleType::Type TitleType) const override;
    
    // èŠ‚ç‚¹æç¤º
    virtual FText GetTooltipText() const override;
    
    // èœå•æ³¨å†Œ
    virtual void GetMenuActions(FBlueprintActionDatabaseRegistrar& ActionRegistrar) const override;
    
    // å¼•è„šåˆ†é…
    virtual void AllocateDefaultPins() override;
    
    // èŠ‚ç‚¹é‡æ„
    virtual void ReconstructNode() override;
    
    // ä»£ç ç”Ÿæˆï¼ˆæ ¸å¿ƒï¼‰
    virtual void ExpandNode(class FKismetCompilerContext& CompilerContext, UEdGraph* SourceGraph) override;
    
    // å¼•è„šç±»å‹å˜åŒ–å¤„ç†
    virtual void PinTypeChanged(UEdGraphPin* Pin) override;

private:
    // è·å–ç›®æ ‡å‡½æ•°
    virtual UFunction* GetTargetFunction() const override;
    
    // åˆ›å»ºè¾“å‡ºå¼•è„š
    void CreateOutputPins();
    
    // å¤„ç†ç±»å‹æ¨æ–­
    void HandleClassPinChanged();
    
    // ç”Ÿæˆæ± åŒ–é€»è¾‘
    void GeneratePoolSpawnCode(FKismetCompilerContext& CompilerContext, UEdGraph* SourceGraph);
};
```
2. å…³é”®å®ç°ç»†èŠ‚
```cpp
UK2Node_SpawnActorFromPool::UK2Node_SpawnActorFromPool()
{
    // è®¾ç½®ç›®æ ‡å‡½æ•°ä¸ºæˆ‘ä»¬çš„æ± åŒ–å‡½æ•°
    FunctionReference.SetExternalMember(
        GET_FUNCTION_NAME_CHECKED(UObjectPoolLibrary, SpawnActorFromPoolSmart), 
        UObjectPoolLibrary::StaticClass()
    );
}

FText UK2Node_SpawnActorFromPool::GetNodeTitle(ENodeTitleType::Type TitleType) const
{
    return LOCTEXT("SpawnActorFromPool_Title", "Spawn Actor from Class (Pooled)");
}

FText UK2Node_SpawnActorFromPool::GetTooltipText() const
{
    return LOCTEXT("SpawnActorFromPool_Tooltip", 
        "æ™ºèƒ½ç”ŸæˆActorï¼šä¼˜å…ˆä»å¯¹è±¡æ± è·å–ï¼Œå¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ°æ­£å¸¸ç”Ÿæˆã€‚"
        "å®Œå…¨å…¼å®¹åŸç”ŸSpawnActorï¼Œä½†æ€§èƒ½æ›´ä¼˜ã€‚");
}

void UK2Node_SpawnActorFromPool::AllocateDefaultPins()
{
    // æ‰§è¡Œå¼•è„š
    CreatePin(EGPD_Input, UEdGraphSchema_K2::PC_Exec, UEdGraphSchema_K2::PN_Execute);
    CreatePin(EGPD_Output, UEdGraphSchema_K2::PC_Exec, UEdGraphSchema_K2::PN_Then);

    // è¾“å…¥å¼•è„š
    CreatePin(EGPD_Input, UEdGraphSchema_K2::PC_Class, TEXT("Class"));
    CreatePin(EGPD_Input, UEdGraphSchema_K2::PC_Struct, TBaseStructure<FTransform>::Get(), TEXT("SpawnTransform"));
    
    // é«˜çº§é€‰é¡¹ï¼ˆæŠ˜å ï¼‰
    UEdGraphPin* CollisionPin = CreatePin(EGPD_Input, UEdGraphSchema_K2::PC_Byte, 
        StaticEnum<ESpawnActorCollisionHandlingMethod>(), TEXT("CollisionHandlingOverride"));
    CollisionPin->bAdvancedView = true;
    
    UEdGraphPin* OwnerPin = CreatePin(EGPD_Input, UEdGraphSchema_K2::PC_Object, AActor::StaticClass(), TEXT("Owner"));
    OwnerPin->bAdvancedView = true;
    
    UEdGraphPin* InstigatorPin = CreatePin(EGPD_Input, UEdGraphSchema_K2::PC_Object, APawn::StaticClass(), TEXT("Instigator"));
    InstigatorPin->bAdvancedView = true;

    // æ± åŒ–é€‰é¡¹
    UEdGraphPin* UsePoolPin = CreatePin(EGPD_Input, UEdGraphSchema_K2::PC_Boolean, TEXT("UsePool"));
    UsePoolPin->DefaultValue = TEXT("true");
    UsePoolPin->bAdvancedView = true;
    UsePoolPin->PinFriendlyName = LOCTEXT("UsePool", "Use Object Pool");

    // è¾“å‡ºå¼•è„šï¼ˆåŠ¨æ€ç±»å‹ï¼‰
    CreatePin(EGPD_Output, UEdGraphSchema_K2::PC_Object, AActor::StaticClass(), UEdGraphSchema_K2::PN_ReturnValue);

    Super::AllocateDefaultPins();
}

void UK2Node_SpawnActorFromPool::PinTypeChanged(UEdGraphPin* Pin)
{
    Super::PinTypeChanged(Pin);

    if (Pin && Pin->PinName == TEXT("Class"))
    {
        // å½“Classå¼•è„šç±»å‹æ”¹å˜æ—¶ï¼Œæ›´æ–°è¿”å›å€¼å¼•è„šç±»å‹
        UEdGraphPin* ReturnPin = GetReturnValuePin();
        if (ReturnPin && Pin->PinType.PinSubCategoryObject.IsValid())
        {
            ReturnPin->PinType.PinSubCategoryObject = Pin->PinType.PinSubCategoryObject;
        }
    }
}

void UK2Node_SpawnActorFromPool::ExpandNode(FKismetCompilerContext& CompilerContext, UEdGraph* SourceGraph)
{
    // æ£€æŸ¥æ˜¯å¦å¯ç”¨æ± åŒ–
    UEdGraphPin* UsePoolPin = FindPin(TEXT("UsePool"));
    bool bUsePool = UsePoolPin && UsePoolPin->DefaultValue == TEXT("true");

    if (bUsePool)
    {
        // ç”Ÿæˆæ± åŒ–é€»è¾‘ï¼š
        // 1. å°è¯•ä»æ± è·å–
        // 2. å¤±è´¥åˆ™å›é€€åˆ°åŸç”ŸSpawnActor
        GeneratePoolSpawnCode(CompilerContext, SourceGraph);
    }
    else
    {
        // ä½¿ç”¨åŸç”Ÿé€»è¾‘
        Super::ExpandNode(CompilerContext, SourceGraph);
    }
}
```
3. é…å¥—çš„è“å›¾å‡½æ•°åº“å‡½æ•°
```cpp
// ä¸ºK2Nodeæä¾›çš„åç«¯å‡½æ•°
UFUNCTION(BlueprintCallable, Category = "XTools|å¯¹è±¡æ± ", 
    meta = (BlueprintInternalUseOnly = "true"))  // åªä¾›K2Nodeå†…éƒ¨ä½¿ç”¨
static AActor* SpawnActorFromPoolSmart(
    const UObject* WorldContext,
    TSubclassOf<AActor> Class,
    const FTransform& SpawnTransform = FTransform::Identity,
    ESpawnActorCollisionHandlingMethod CollisionHandlingOverride = ESpawnActorCollisionHandlingMethod::Undefined,
    AActor* Owner = nullptr,
    APawn* Instigator = nullptr,
    bool UsePool = true
);

// å®ç°
AActor* UObjectPoolLibrary::SpawnActorFromPoolSmart(
    const UObject* WorldContext,
    TSubclassOf<AActor> Class,
    const FTransform& SpawnTransform,
    ESpawnActorCollisionHandlingMethod CollisionHandlingOverride,
    AActor* Owner,
    APawn* Instigator,
    bool UsePool)
{
    // 1. æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æ± 
    if (UsePool)
    {
        // 2. å°è¯•ä»å¯¹è±¡æ± è·å–
        if (UObjectPoolSubsystem* PoolSystem = UObjectPoolSubsystem::Get(WorldContext))
        {
            // æ£€æŸ¥æ˜¯å¦å·²æ³¨å†Œ
            if (!PoolSystem->IsActorClassRegistered(Class))
            {
                // è‡ªåŠ¨æ³¨å†Œ
                PoolSystem->RegisterActorClass(Class, 10);  // é»˜è®¤æ± å¤§å°
            }
            
            AActor* PooledActor = PoolSystem->SpawnActorFromPool(Class, SpawnTransform);
            if (PooledActor)
            {
                // è®¾ç½®Ownerå’ŒInstigatorï¼ˆæ± åŒ–Actorä¹Ÿéœ€è¦è¿™äº›å±æ€§ï¼‰
                if (Owner) PooledActor->SetOwner(Owner);
                if (Instigator) PooledActor->SetInstigator(Instigator);
                
                return PooledActor;
            }
        }
    }

    // 3. å›é€€åˆ°åŸç”ŸSpawnActor
    UWorld* World = GEngine->GetWorldFromContextObject(WorldContext, EGetWorldErrorMode::LogAndReturnNull);
    if (!World) return nullptr;

    FActorSpawnParameters SpawnParams;
    SpawnParams.SpawnCollisionHandlingOverride = CollisionHandlingOverride;
    SpawnParams.Owner = Owner;
    SpawnParams.Instigator = Instigator;

    return World->SpawnActor<AActor>(Class, SpawnTransform, SpawnParams);
}
```
ğŸš€ æ‰©å±•åŠŸèƒ½
æ± åŒ–çŠ¶æ€å¯è§†åŒ–
```cpp
// åœ¨K2Nodeä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
void UK2Node_SpawnActorFromPool::GetNodeContextMenuActions(UToolMenu* Menu, UGraphNodeContextMenuContext* Context) const
{
    Super::GetNodeContextMenuActions(Menu, Context);
    
    // æ·»åŠ "æ˜¾ç¤ºæ± çŠ¶æ€"èœå•é¡¹
    FToolMenuSection& Section = Menu->FindOrAddSection("K2NodeSpawnActorFromPool");
    Section.AddMenuEntry(
        "ShowPoolStatus",
        LOCTEXT("ShowPoolStatus", "Show Pool Status"),
        LOCTEXT("ShowPoolStatus_Tooltip", "æ˜¾ç¤ºæ­¤Actorç±»çš„å¯¹è±¡æ± çŠ¶æ€"),
        FSlateIcon(),
        FUIAction(
            FExecuteAction::CreateUObject(this, &UK2Node_SpawnActorFromPool::ShowPoolStatus)
        )
    );
}

// æ˜¾ç¤ºæ± çŠ¶æ€
void UK2Node_SpawnActorFromPool::ShowPoolStatus() const
{
    // è·å–Classå¼•è„šè¿æ¥çš„ç±»
    UEdGraphPin* ClassPin = FindPin(TEXT("Class"));
    if (!ClassPin || ClassPin->LinkedTo.Num() == 0)
    {
        return;
    }
    
    // è·å–è¿æ¥çš„ç±»
    UClass* ActorClass = Cast<UClass>(ClassPin->LinkedTo[0]->PinType.PinSubCategoryObject.Get());
    if (!ActorClass)
    {
        return;
    }
    
    // è·å–å¯¹è±¡æ± å­ç³»ç»Ÿ
    UObjectPoolSubsystem* PoolSystem = UObjectPoolSubsystem::GetGlobal();
    if (!PoolSystem)
    {
        return;
    }
    
    // è·å–æ± çŠ¶æ€
    FObjectPoolStats Stats = PoolSystem->GetPoolStats(ActorClass);
    
    // æ˜¾ç¤ºçŠ¶æ€çª—å£
    FText StatusText = FText::Format(
        LOCTEXT("PoolStatus", "Pool Status for {0}:\nActive: {1}\nAvailable: {2}\nTotal Created: {3}\nHit Rate: {4}%"),
        FText::FromString(ActorClass->GetName()),
        FText::AsNumber(Stats.CurrentActive),
        FText::AsNumber(Stats.CurrentAvailable),
        FText::AsNumber(Stats.TotalCreated),
        FText::AsNumber(Stats.HitRate * 100.0f)
    );
    
    FMessageDialog::Open(EAppMsgType::Ok, StatusText);
}
```

