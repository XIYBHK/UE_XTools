name: Build XTools Plugin

on:
  workflow_dispatch:
    inputs:
      ue_versions:
        description: 'UE Versions to build (comma-separated)'
        required: false
        default: '5.3,5.4,5.5,5.6'
        type: string
      platforms:
        description: 'Platforms to build (use + to separate multiple platforms)'
        required: false
        default: 'Win64+Linux+Mac'
        type: string
      clean_build:
        description: 'Clean build'
        required: false
        default: true
        type: boolean

env:
  PLUGIN_NAME: 'XTools'
  PLUGIN_FILE: 'XTools.uplugin'

jobs:
  # ä¸»æž„å»ºä»»åŠ¡ - ç®€åŒ–ç‰ˆï¼Œä¸€æ¬¡æž„å»ºæ‰€æœ‰å¹³å°
  build:
    runs-on: self-hosted  # ä½¿ç”¨è‡ªæ‰˜ç®¡è¿è¡Œå™¨ï¼Œé¢„è£…æ‰€æœ‰UEç‰ˆæœ¬
    strategy:
      fail-fast: false
      matrix:
        ue_version: ['5.3', '5.4', '5.5', '5.6']
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup UE Environment
      shell: pwsh -ExecutionPolicy Bypass {0}
      run: |
        # ä¸Žæ‚¨çš„å®žé™…å®‰è£…è·¯å¾„ä¿æŒä¸€è‡´çš„è·¯å¾„æ£€æµ‹é€»è¾‘
        $ue_paths = @(
          "F:\Epic Games\UE_${{ matrix.ue_version }}",  # æ‚¨çš„å®žé™…å®‰è£…è·¯å¾„ï¼ˆFç›˜ï¼‰
          "D:\Program Files\Epic Games\UE_${{ matrix.ue_version }}",
          "C:\Program Files\Epic Games\UE_${{ matrix.ue_version }}"
        )
        
        $ue_path = $null
        foreach ($path in $ue_paths) {
          if (Test-Path $path) {
            $ue_path = $path
            break
          }
        }
        
        if (-not $ue_path) {
          Write-Error "âŒ UE ${{ matrix.ue_version }} not found in any of these locations: $($ue_paths -join ', ')"
          exit 1
        }
        
        echo "UE_PATH=$ue_path" >> $env:GITHUB_ENV
        echo "UE_VERSION=${{ matrix.ue_version }}" >> $env:GITHUB_ENV
        Write-Host "ðŸŽ¯ Using local UE installation at: $ue_path"
        
        # æ£€æµ‹VS2022å®‰è£…è·¯å¾„ï¼ˆé€‚é…æ‚¨çš„Eç›˜å®‰è£…ï¼‰
        $vs_paths = @(
          "E:\VisualStudio\2022",  # æ‚¨çš„å®žé™…VSå®‰è£…è·¯å¾„
          "C:\Program Files\Microsoft Visual Studio\2022\Community",
          "C:\Program Files\Microsoft Visual Studio\2022\Professional",
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise",
          "C:\Program Files (x86)\Microsoft Visual Studio\2022\BuildTools"
        )
        
        $vs_path = $null
        foreach ($path in $vs_paths) {
          if (Test-Path $path) {
            $vs_path = $path
            break
          }
        }
        
        if ($vs_path) {
          echo "VS2022INSTALLDIR=$vs_path" >> $env:GITHUB_ENV
          Write-Host "ðŸ”§ Found VS2022 at: $vs_path"
        } else {
          Write-Host "âš ï¸ VS2022 not found in expected locations, UE BuildTool will auto-detect"
        }
        
    - name: Verify UE Installation
      shell: pwsh -ExecutionPolicy Bypass {0}
      run: |
        $uat_path = "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
        if (Test-Path $uat_path) {
          Write-Host "âœ… Found UE ${{ matrix.ue_version }} at: $env:UE_PATH"
        } else {
          Write-Error "âŒ UE ${{ matrix.ue_version }} not found at: $env:UE_PATH"
          exit 1
        }
        
    # ðŸŽ¯ ä¸€æ¡å‘½ä»¤æž„å»ºæ‰€æœ‰å¹³å°ï¼
    - name: Build XTools Plugin (All Platforms)
      shell: pwsh -ExecutionPolicy Bypass {0}
      run: |
        $plugin_path = "${{ github.workspace }}\${{ env.PLUGIN_FILE }}"
        $output_path = "${{ github.workspace }}\PackagedPlugin\${{ env.PLUGIN_NAME }}-UE_${{ matrix.ue_version }}-AllPlatforms"
        $uat_path = "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
        $platforms = "${{ github.event.inputs.platforms || 'Win64+Linux+Mac' }}"
        
        Write-Host "Building ${{ env.PLUGIN_NAME }} plugin for platforms: $platforms"
        Write-Host "Plugin: $plugin_path"
        Write-Host "Output: $output_path"
        
        # æ¸…ç†è¾“å‡ºç›®å½•
        if ("${{ github.event.inputs.clean_build || 'true' }}" -eq "true") {
          if (Test-Path $output_path) {
            Remove-Item -Recurse -Force $output_path
            Write-Host "ðŸ§¹ Cleaned output directory"
          }
        }
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Force -Path $output_path | Out-Null
        
        # æž„å»ºæ’ä»¶
        & $uat_path BuildPlugin `
          -Plugin="$plugin_path" `
          -Package="$output_path" `
          -TargetPlatforms=$platforms `
          -StrictIncludes `
          -NoHostProject
          
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Plugin build failed with exit code: $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        Write-Host "âœ… Build completed successfully for all platforms!"
        
    # æ£€æŸ¥å’Œåˆ—å‡ºæž„å»ºäº§ç‰©
    - name: List Build Artifacts
      shell: pwsh -ExecutionPolicy Bypass {0}
      run: |
        $output_path = "${{ github.workspace }}\PackagedPlugin\${{ env.PLUGIN_NAME }}-UE_${{ matrix.ue_version }}-AllPlatforms"
        
        if (Test-Path $output_path) {
          Write-Host "ðŸ“¦ Build artifacts for UE ${{ matrix.ue_version }} (All Platforms):"
          
          Write-Host "`nðŸªŸ Windows binaries (.dll):"
          Get-ChildItem -Path $output_path -Filter "*.dll" -Recurse | ForEach-Object { "  $_" }
          
          Write-Host "`nðŸ§ Linux binaries (.so):"
          Get-ChildItem -Path $output_path -Filter "*.so" -Recurse | ForEach-Object { "  $_" }
          
          Write-Host "`nðŸŽ Mac binaries (.dylib):"
          Get-ChildItem -Path $output_path -Filter "*.dylib" -Recurse | ForEach-Object { "  $_" }
          
          Write-Host "`nðŸ“„ Plugin files (.uplugin):"
          Get-ChildItem -Path $output_path -Filter "*.uplugin" -Recurse | ForEach-Object { "  $_" }
          
          # è®¡ç®—æ€»å¤§å°
          $totalSize = (Get-ChildItem -Path $output_path -Recurse -File | Measure-Object -Property Length -Sum).Sum
          Write-Host "`nðŸ“Š Total size: $([math]::Round($totalSize/1MB, 2)) MB"
        } else {
          Write-Warning "âŒ No build output found at: $output_path"
        }
        
    # ä¸Šä¼ æž„å»ºäº§ç‰©
    - name: Upload Plugin Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PLUGIN_NAME }}-UE_${{ matrix.ue_version }}-AllPlatforms
        path: PackagedPlugin/${{ env.PLUGIN_NAME }}-UE_${{ matrix.ue_version }}-AllPlatforms/
        retention-days: 30
        
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
    - name: Cleanup
      if: always()
      shell: bash
      run: |
        # æ¸…ç†ä¸´æ—¶æž„å»ºæ–‡ä»¶ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´
        rm -rf PackagedPlugin/ || true
        echo "Cleanup completed"

  # å‘å¸ƒä»»åŠ¡ï¼ˆä»…åœ¨TagæŽ¨é€æ—¶æ‰§è¡Œï¼‰
  release:
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build]
    runs-on: self-hosted  # åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä¸Šåˆ›å»ºå‘å¸ƒåŒ…
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    # ä¸‹è½½æ‰€æœ‰æž„å»ºäº§ç‰©
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
        
    # åˆ›å»ºå‘å¸ƒåŒ…
    - name: Create Release Packages
      shell: bash
      run: |
        mkdir -p release_packages
        
        # ä¸ºæ¯ä¸ªç‰ˆæœ¬å’Œå¹³å°åˆ›å»ºZIPåŒ…
        cd artifacts
        for artifact_dir in */; do
          if [ -d "$artifact_dir" ]; then
            artifact_name=$(basename "$artifact_dir")
            echo "Creating package for: $artifact_name"
            cd "$artifact_dir"
            zip -r "../../release_packages/${artifact_name}.zip" ./*
            cd ..
          fi
        done
        
        # åˆ›å»ºå®Œæ•´ç‰ˆæœ¬åŒ…ï¼ˆæ‰€æœ‰å¹³å°ï¼‰
        cd ..
        zip -r "release_packages/${{ env.PLUGIN_NAME }}-${{ github.ref_name }}-All-Platforms.zip" artifacts/
        
        echo "Release packages created:"
        ls -la release_packages/
        
    # åˆ›å»ºGitHub Release
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: release_packages/*
        generate_release_notes: true
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # æž„å»ºæŠ¥å‘Š
  report:
    if: always()
    needs: [build]
    runs-on: self-hosted  # åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä¸Šç”ŸæˆæŠ¥å‘Š
    
    steps:
    - name: Build Report
      shell: pwsh -ExecutionPolicy Bypass {0}
      run: |
        echo "## XTools Plugin Build Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æž„å»ºé…ç½®ä¿¡æ¯
        echo "### Build Configuration" >> $GITHUB_STEP_SUMMARY
        echo "**UE Versions:** ${{ github.event.inputs.ue_versions || '5.3, 5.4, 5.5, 5.6' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Platforms:** ${{ github.event.inputs.platforms || 'Win64+Linux+Mac' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Clean Build:** ${{ github.event.inputs.clean_build || 'true' }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # æž„å»ºçŠ¶æ€
        echo "### Build Status" >> $GITHUB_STEP_SUMMARY
        echo "Build job result: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ startsWith(github.ref, 'refs/tags/v') }}" == "true" ]]; then
          echo "ðŸš€ **Release build completed for tag:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        else
          echo "ðŸ”§ **Development build completed**" >> $GITHUB_STEP_SUMMARY
        fi
