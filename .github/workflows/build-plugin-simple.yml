name: Build XTools Plugin (Simplified)

on:
  workflow_dispatch:

jobs:
  # Windows æž„å»º (ä½¿ç”¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä½œä¸ºè‡ªæ‰˜ç®¡è¿è¡Œå™¨)
  build-windows:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        ue_version: ['5.3', '5.4', '5.5', '5.6']
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    # ä½¿ç”¨æ‚¨æœ¬åœ°ç”µè„‘ä¸Šé¢„å®‰è£…çš„UEç‰ˆæœ¬
    - name: Setup UE Path
      run: |
        # æ ¹æ®æ‚¨çš„å®žé™…UEå®‰è£…è·¯å¾„è°ƒæ•´
        # Fç›˜: F:\Epic Games\UE_5.x\Engine
        $ue_paths = @(
          "F:\Epic Games\UE_${{ matrix.ue_version }}",  # æ‚¨çš„å®žé™…å®‰è£…è·¯å¾„
          "D:\Program Files\Epic Games\UE_${{ matrix.ue_version }}",
          "C:\Program Files\Epic Games\UE_${{ matrix.ue_version }}"
        )
        
        $ue_path = $null
        foreach ($path in $ue_paths) {
          if (Test-Path $path) {
            $ue_path = $path
            break
          }
        }
        
        if (-not $ue_path) {
          Write-Error "âŒ UE ${{ matrix.ue_version }} not found in any of these locations: $($ue_paths -join ', ')"
          exit 1
        }
        echo "UE_PATH=$ue_path" >> $env:GITHUB_ENV
        echo "UE_VERSION=${{ matrix.ue_version }}" >> $env:GITHUB_ENV
        Write-Host "ðŸŽ¯ Using UE installation at: $ue_path"
        
        # æ£€æµ‹VS2022å®‰è£…è·¯å¾„ï¼ˆé€‚é…æ‚¨çš„Eç›˜å®‰è£…ï¼‰
        $vs_paths = @(
          "E:\VisualStudio\2022",  # æ‚¨çš„å®žé™…VSå®‰è£…è·¯å¾„
          "C:\Program Files\Microsoft Visual Studio\2022\Community",
          "C:\Program Files\Microsoft Visual Studio\2022\Professional",
          "C:\Program Files\Microsoft Visual Studio\2022\Enterprise"
        )
        
        $vs_path = $null
        foreach ($path in $vs_paths) {
          if (Test-Path $path) {
            $vs_path = $path
            break
          }
        }
        
        if ($vs_path) {
          echo "VS2022INSTALLDIR=$vs_path" >> $env:GITHUB_ENV
          Write-Host "ðŸ”§ Found VS2022 at: $vs_path"
        } else {
          Write-Host "âš ï¸ VS2022 not found, UE BuildTool will auto-detect"
        }
        
    # æ‰‹åŠ¨æž„å»ºæ’ä»¶ï¼ˆæ”¯æŒä¸‰å¹³å°ï¼šWin64+Linux+Macï¼‰
    - name: Build Plugin
      run: |
        $plugin_path = "${{ github.workspace }}\XTools.uplugin"
        $output_path = "${{ github.workspace }}\PackagedPlugin\XTools-UE_${{ matrix.ue_version }}-AllPlatforms"
        $uat_path = "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
        
        Write-Host "Building plugin for ALL platforms (Win64+Linux+Mac):"
        Write-Host "  Plugin: $plugin_path"
        Write-Host "  Output: $output_path"
        Write-Host "  UAT: $uat_path"
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        New-Item -ItemType Directory -Force -Path $output_path | Out-Null
        
        # ðŸŽ¯ ä¸€æ¡å‘½ä»¤æž„å»ºä¸‰å¹³å°ï¼
        & $uat_path BuildPlugin `
          -Plugin="$plugin_path" `
          -Package="$output_path" `
          -TargetPlatforms=Win64+Linux+Mac `
          -StrictIncludes `
          -NoHostProject
          
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Plugin build failed with exit code: $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        Write-Host "Build completed successfully!"
        
    - name: List Build Output
      run: |
        $output_path = "${{ github.workspace }}\PackagedPlugin\XTools-UE_${{ matrix.ue_version }}-AllPlatforms"
        if (Test-Path $output_path) {
          Write-Host "Build artifacts for ALL platforms:"
          Write-Host "Windows binaries:"
          Get-ChildItem -Path "$output_path" -Filter "*.dll" -Recurse | Select-Object FullName
          Write-Host "Linux binaries:"  
          Get-ChildItem -Path "$output_path" -Filter "*.so" -Recurse | Select-Object FullName
          Write-Host "Mac binaries:"
          Get-ChildItem -Path "$output_path" -Filter "*.dylib" -Recurse | Select-Object FullName
          Write-Host "All files:"
          Get-ChildItem -Path $output_path -Recurse | Select-Object FullName, Length | Format-Table
        } else {
          Write-Host "No build output found at: $output_path"
        }
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: XTools-UE_${{ matrix.ue_version }}-AllPlatforms
        path: PackagedPlugin/XTools-UE_${{ matrix.ue_version }}-AllPlatforms/
        retention-days: 7

  # æ±‡æ€»æž„å»ºç»“æžœ
  summary:
    if: always()
    needs: [build-windows]
    runs-on: self-hosted  # åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä¸Šè¿è¡Œæ±‡æ€»
    
    steps:
    - name: Build Summary
      run: |
        echo "## XTools Plugin Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Windows Build Results" >> $GITHUB_STEP_SUMMARY
        echo "- UE 5.3: ${{ needs.build-windows.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- UE 5.4: ${{ needs.build-windows.result }}" >> $GITHUB_STEP_SUMMARY  
        echo "- UE 5.5: ${{ needs.build-windows.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- UE 5.6: ${{ needs.build-windows.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ "${{ needs.build-windows.result }}" == "success" ]]; then
          echo "âœ… All builds completed successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ Some builds failed. Check the logs for details." >> $GITHUB_STEP_SUMMARY
        fi
