name: Build XTools Plugin (Simplified)

on:
  workflow_dispatch:

jobs:
  # Windows æž„å»º (ä½¿ç”¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä½œä¸ºè‡ªæ‰˜ç®¡è¿è¡Œå™¨)
  build-windows:
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        ue_version: ['5.3']  # å…ˆä¸“æ³¨äºŽ5.3ç‰ˆæœ¬ï¼Œè·‘é€šåŽå†æ·»åŠ å…¶ä»–ç‰ˆæœ¬
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    # Use pre-installed UE version on your local computer
    - name: Setup UE Path
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        # Focus on UE 5.3 version - adjust according to your actual installation path
        # F Drive: F:\Epic Games\UE_5.3\Engine
        Write-Host "ðŸ” Detecting UE 5.3 installation path..."
        $ue_paths = @(
          "F:\Epic Games\UE_5.3",  # Your actual installation path (F drive)
          "D:\Program Files\Epic Games\UE_5.3",
          "C:\Program Files\Epic Games\UE_5.3"
        )
        
        $ue_path = $null
        foreach ($path in $ue_paths) {
          Write-Host "  Checking path: $path"
          if (Test-Path $path) {
            $ue_path = $path
            Write-Host "  âœ… Found UE installation: $path"
            break
          } else {
            Write-Host "  âŒ Path not found: $path"
          }
        }
        
        if (-not $ue_path) {
          Write-Error "âŒ Error: UE 5.3 not found in any of these locations: $($ue_paths -join ', ')"
          exit 1
        }
        
        # éªŒè¯å…³é”®æ–‡ä»¶
        $uat_path = "$ue_path\Engine\Build\BatchFiles\RunUAT.bat"
        if (-not (Test-Path $uat_path)) {
          Write-Error "âŒ Error: RunUAT.bat not found at: $uat_path"
          exit 1
        }
        
        echo "UE_PATH=$ue_path" >> $env:GITHUB_ENV
        echo "UE_VERSION=5.3" >> $env:GITHUB_ENV
        Write-Host "ðŸŽ¯ Using UE 5.3 installation at: $ue_path"
        Write-Host "ðŸ”§ Found RunUAT.bat at: $uat_path"
        
        # Detect VS2022 installation path (simplified)
        Write-Host "ðŸ” Detecting VS2022 installation path..."
        $vs_main_path = "E:\VisualStudio\2022"
        if (Test-Path $vs_main_path) {
          echo "VS2022INSTALLDIR=$vs_main_path" >> $env:GITHUB_ENV
          Write-Host "ðŸ”§ Found VS2022 at: $vs_main_path"
        } else {
          Write-Host "âš ï¸ Warning: VS2022 not found at E:\VisualStudio\2022, UE BuildTool will auto-detect"
        }
        
        # Verify plugin file exists
        $plugin_file = "${{ github.workspace }}\XTools.uplugin"
        Write-Host "ðŸ” Checking plugin file: $plugin_file"
        if (Test-Path $plugin_file) {
          Write-Host "âœ… Plugin file exists: $plugin_file"
        } else {
          Write-Error "âŒ Error: Plugin file not found: $plugin_file"
          exit 1
        }
        
    # Manual plugin build (supports three platforms: Win64+Linux+Mac)
    - name: Build Plugin
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "ðŸš€ Starting XTools plugin build (UE 5.3)..."
        
        $plugin_path = "${{ github.workspace }}\XTools.uplugin"
        $output_path = "${{ github.workspace }}\PackagedPlugin\XTools-UE_5.3-AllPlatforms"
        $uat_path = "$env:UE_PATH\Engine\Build\BatchFiles\RunUAT.bat"
        
        Write-Host "ðŸ“‹ Build Configuration:"
        Write-Host "  ðŸŽ® UE Version: 5.3"
        Write-Host "  ðŸ“¦ Plugin File: $plugin_path"  
        Write-Host "  ðŸ“ Output Directory: $output_path"
        Write-Host "  ðŸ”§ UAT Tool: $uat_path"
        Write-Host "  ðŸŽ¯ Target Platforms: Win64+Linux+Mac"
        
        # Create output directory
        New-Item -ItemType Directory -Force -Path $output_path | Out-Null
        
        # Create temporary host project to build plugin (fixes generated.h missing issue)
        $tempProjectPath = "${{ github.workspace }}\TempProject"
        $tempProjectFile = "$tempProjectPath\TempProject.uproject"
        
        Write-Host "ðŸ”¨ Creating temporary UE project..."
        New-Item -ItemType Directory -Force -Path $tempProjectPath | Out-Null
        
        # Create minimal .uproject file
        $uprojectContent = '{"FileVersion": 3,"EngineAssociation": "5.3","Category": "","Description": "","Modules": [],"Plugins": [{"Name": "XTools","Enabled": true}]}'
        
        $uprojectContent | Out-File -FilePath $tempProjectFile -Encoding UTF8
        Write-Host "âœ… Temporary project created: $tempProjectFile"
        
        # Start building cross-platform plugin
        Write-Host "ðŸ—ï¸ Building plugin with host project..."
        Write-Host ""
        
        $buildArgs = @(
          "BuildPlugin"
          "-Plugin=`"$plugin_path`""
          "-Package=`"$output_path`""
          "-TargetPlatforms=Win64+Linux+Mac"
          "-StrictIncludes"
          "-Project=`"$tempProjectFile`""
        )
        
        Write-Host "âš¡ Executing build command:"
        Write-Host "  $uat_path $($buildArgs -join ' ')"
        Write-Host ""
        
        & $uat_path @buildArgs
          
        if ($LASTEXITCODE -ne 0) {
          Write-Host ""
          Write-Error "âŒ Error: Plugin build failed with exit code: $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        Write-Host ""
        Write-Host "ðŸŽ‰ Build completed: UE 5.3 plugin build successful"
        
        # Clean up temporary project
        Write-Host "ðŸ§¹ Cleaning up temporary project..."
        if (Test-Path $tempProjectPath) {
          Remove-Item -Path $tempProjectPath -Recurse -Force
          Write-Host "âœ… Temporary project cleaned up"
        }
        
    - name: List Build Output
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "ðŸ” Checking UE 5.3 build output..."
        $output_path = "${{ github.workspace }}\PackagedPlugin\XTools-UE_5.3-AllPlatforms"
        
        if (Test-Path $output_path) {
          Write-Host "âœ… Build output directory exists: $output_path"
          Write-Host ""
          
          # ç»Ÿè®¡æ–‡ä»¶
          $allFiles = Get-ChildItem -Path $output_path -Recurse -File
          $totalSize = ($allFiles | Measure-Object -Property Length -Sum).Sum
          Write-Host "ðŸ“Š Build Statistics:"
          Write-Host "  ðŸ“ Total Files: $($allFiles.Count)"
          Write-Host "  ðŸ“ Total Size: $([math]::Round($totalSize/1MB, 2)) MB"
          Write-Host ""
          
          # Windowså¹³å°æ–‡ä»¶
          $winFiles = Get-ChildItem -Path "$output_path" -Filter "*.dll" -Recurse
          Write-Host "ðŸªŸ Windows Binary Files ($($winFiles.Count)):"
          $winFiles | ForEach-Object { Write-Host "  ðŸ“„ File: $($_.FullName)" }
          Write-Host ""
          
          # Linuxå¹³å°æ–‡ä»¶  
          $linuxFiles = Get-ChildItem -Path "$output_path" -Filter "*.so" -Recurse
          Write-Host "ðŸ§ Linux Binary Files ($($linuxFiles.Count)):"
          $linuxFiles | ForEach-Object { Write-Host "  ðŸ“„ File: $($_.FullName)" }
          Write-Host ""
          
          # Macå¹³å°æ–‡ä»¶
          $macFiles = Get-ChildItem -Path "$output_path" -Filter "*.dylib" -Recurse
          Write-Host "ðŸŽ Mac Binary Files ($($macFiles.Count)):"
          $macFiles | ForEach-Object { Write-Host "  ðŸ“„ File: $($_.FullName)" }
          Write-Host ""
          
          # æ’ä»¶é…ç½®æ–‡ä»¶
          $upluginFiles = Get-ChildItem -Path "$output_path" -Filter "*.uplugin" -Recurse
          Write-Host "âš™ï¸ Plugin Configuration Files ($($upluginFiles.Count)):"
          $upluginFiles | ForEach-Object { Write-Host "  ðŸ“„ File: $($_.FullName)" }
          
        } else {
          Write-Error "âŒ Error: Build output directory not found: $output_path"
          exit 1
        }
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: XTools-UE_5.3-AllPlatforms
        path: PackagedPlugin/XTools-UE_5.3-AllPlatforms/
        retention-days: 7

  # Summarize build results
  summary:
    if: always()
    needs: [build-windows]
    runs-on: self-hosted  # Run summary on your local computer
    
    steps:
    - name: Build Summary
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "ðŸ“‹ Generating build summary report..."
        
        echo "## XTools Plugin Build Summary (UE 5.3 Focus)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Build Time:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $GITHUB_STEP_SUMMARY
        echo "**Commit Hash:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Runner:** Self-Hosted" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### UE 5.3 Build Results" >> $GITHUB_STEP_SUMMARY
        $buildResult = "${{ needs.build-windows.result }}"
        if ($buildResult -eq "success") {
          echo "- **UE 5.3**: Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- **Multi-Platform Support**: Win64 + Linux + Mac" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact Name**: \`XTools-UE_5.3-AllPlatforms\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Retention**: 7 days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps**: After successful testing, can add UE 5.4, 5.5, 5.6 versions to build matrix" >> $GITHUB_STEP_SUMMARY
        } else {
          echo "- **UE 5.3**: Build Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting**: Please check build logs for detailed error information" >> $GITHUB_STEP_SUMMARY
        }
        
        Write-Host "Build summary report generated"
