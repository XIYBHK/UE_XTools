name: Build XTools Plugin (Optimized BuildPlugin)

on:
  workflow_dispatch:
    inputs:
      ue_version:
        description: 'UE Version to build (select "all" to build all versions)'
        required: true
        type: choice
        options:
          - 'all'
          - '5.3'
          - '5.4'
          - '5.5'
          - '5.6'
          - '5.7'
        default: 'all'
  push:
    tags:
      - 'v*'

jobs:
  # 验证 MSVC 工具链
  verify-toolchain:
    runs-on: self-hosted
    steps:
    - name: Verify MSVC Toolchain Installation
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "==> Verify MSVC Toolchain for UE 5.3-5.7" -ForegroundColor Cyan

        # Define possible MSVC paths in order of preference
        $possiblePaths = @(
          "E:\VisualStudio\2022\VC\Tools\MSVC",
          "F:\VisualStudio\2022\VC\Tools\MSVC",
          "C:\Program Files (x86)\Microsoft Visual Studio\2022\VC\Tools\MSVC",
          "C:\Program Files\Microsoft Visual Studio\2022\VC\Tools\MSVC"
        )

        $msvcPath = $null
        foreach ($path in $possiblePaths) {
          if (Test-Path $path) {
            $msvcPath = $path
            Write-Host "Found MSVC at: $msvcPath" -ForegroundColor Green
            break
          }
        }

        if (-not $msvcPath) {
          Write-Error "MSVC tools not found in standard locations"
          Write-Host ""
          Write-Host "Searched locations:" -ForegroundColor Yellow
          $possiblePaths | ForEach-Object { Write-Host "  - $_" }
          Write-Host ""
          Write-Host "Please install Visual Studio 2022 with the following components:" -ForegroundColor Yellow
          Write-Host "  - Desktop development with C++ workload" -ForegroundColor Cyan
          Write-Host "  - MSVC v143 - VS 2022 C++ x64/x86 build tools (v14.38-17.8)" -ForegroundColor Red
          exit 1
        }

        $ueRequirements = @{
          "5.3" = "14.38.33130"
          "5.4" = "14.38.33130"
          "5.5" = "14.38.33130"
          "5.6" = "14.38.33130"
          "5.7" = "14.38.33130"  # 可能需要更高版本
        }

        $versions = Get-ChildItem -Path $msvcPath -Directory -ErrorAction SilentlyContinue |
          Select-Object -ExpandProperty Name |
          Sort-Object

        Write-Host "Installed MSVC versions:"
        $versions | ForEach-Object { Write-Host "  - $_" }
        Write-Host ""

        # Check required 14.38.33130 version
        $requiredVersion = "14.38.33130"
        if ($versions -contains $requiredVersion) {
          Write-Host "[OK] Found MSVC $requiredVersion (required for UE 5.3-5.6)" -ForegroundColor Green
        } else {
          Write-Error "Required MSVC version not found: $requiredVersion"
          Write-Host ""
          Write-Host "Installation steps:" -ForegroundColor Yellow
          Write-Host "1. Open Visual Studio Installer" -ForegroundColor Cyan
          Write-Host "2. Click 'Modify' Visual Studio 2022" -ForegroundColor Cyan
          Write-Host "3. Select 'Individual components' tab" -ForegroundColor Cyan
          Write-Host "4. Search and check: MSVC v143 - VS 2022 C++ x64/x86 build tools (v14.38-17.8)" -ForegroundColor Red
          Write-Host "5. Click 'Modify' to start installation" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Please rerun this workflow after installation completes." -ForegroundColor Yellow
          exit 1
        }

        # Check for UE 5.7 compatible versions
        Write-Host "Checking UE 5.7 compatibility..." -ForegroundColor Cyan
        $ue5_7Versions = @("14.40.", "14.41.", "14.42.")
        $hasUE5_7Compatible = $false
        foreach ($version in $versions) {
          foreach ($ue5_7Ver in $ue5_7Versions) {
            if ($version -like "$ue5_7Ver*") {
              $hasUE5_7Compatible = $true
              Write-Host "[INFO] Found UE 5.7 compatible version: $version" -ForegroundColor Green
              break
            }
          }
          if ($hasUE5_7Compatible) { break }
        }

        if (-not $hasUE5_7Compatible) {
          Write-Host "[WARNING] UE 5.7 recommended MSVC version (14.40+) not found" -ForegroundColor Yellow
          Write-Host "If UE 5.7 build fails, install latest MSVC v143 toolchain" -ForegroundColor Yellow
          Write-Host "Will attempt to build UE 5.7 with 14.38.33130..." -ForegroundColor Cyan
        }

        Write-Host ""
        Write-Host "[OK] Toolchain verification passed, ready to build" -ForegroundColor Green

  # 设置编译版本矩阵
  setup-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.ue_version }}" != "all" ]]; then
            echo "matrix=[\"${{ github.event.inputs.ue_version }}\"]" >> $GITHUB_OUTPUT
          else
            echo "matrix=[\"5.3\",\"5.4\",\"5.5\",\"5.6\",\"5.7\"]" >> $GITHUB_OUTPUT
          fi

  build-windows-optimized:
    needs: [verify-toolchain, setup-matrix]
    runs-on: self-hosted
    timeout-minutes: 60
    concurrency:
      group: build-plugin-${{ github.ref }}-${{ matrix.ue_version }}
      cancel-in-progress: true
    strategy:
      fail-fast: false
      matrix:
        ue_version: ${{ fromJSON(needs.setup-matrix.outputs.matrix) }}
    env:
      UE_VERSION: ${{ matrix.ue_version }}
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
      
    - name: Setup UE Environment
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "==> Setup UE ${{ matrix.ue_version }} Environment" -ForegroundColor Cyan
        
        # UE installation path
        $ue_version = "${{ matrix.ue_version }}"
        $ue_path = "F:\Epic Games\UE_$ue_version"
        Write-Host "UE Path: $ue_path"
        
        if (-not (Test-Path $ue_path)) {
          throw "UE installation not found: $ue_path"
        }
        
        # Verify key files
        $runuat_path = "$ue_path\Engine\Build\BatchFiles\RunUAT.bat"
        $ue_editor_path = "$ue_path\Engine\Binaries\Win64\UnrealEditor.exe"
        
        if (-not (Test-Path $runuat_path)) {
          throw "RunUAT.bat not found: $runuat_path"
        }
        
        if (-not (Test-Path $ue_editor_path)) {
          throw "UnrealEditor.exe not found: $ue_editor_path"
        }
        
        # Verify plugin file
        $plugin_file = "${{ github.workspace }}\XTools.uplugin"
        if (-not (Test-Path $plugin_file)) {
          throw "Plugin file not found: $plugin_file"
        }
        
        Write-Host "[OK] Environment validation passed" -ForegroundColor Green
        
        # Set environment variables
        echo "UE_PATH=$ue_path" >> $env:GITHUB_ENV
        echo "UE_VERSION=$ue_version" >> $env:GITHUB_ENV
        echo "RUNUAT_PATH=$runuat_path" >> $env:GITHUB_ENV
        echo "UE_EDITOR_PATH=$ue_editor_path" >> $env:GITHUB_ENV
        echo "PLUGIN_FILE=$plugin_file" >> $env:GITHUB_ENV

    - name: Build Plugin with BuildPlugin Command
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "==> Build Plugin for UE ${{ env.UE_VERSION }}" -ForegroundColor Cyan
        $build_start = Get-Date
        
        # Output directory setup (use RUNNER_TEMP to avoid writing to repo)
        $base_out = Join-Path $env:RUNNER_TEMP "XTools"
        $output_directory = Join-Path $base_out ("XTools-UE_" + $env:UE_VERSION + "-AllPlatforms")
        $temp_output = Join-Path $base_out "TempPackage"
        
        Write-Host "Output Directory: $output_directory"
        
        # Clean old output directories
        if (Test-Path $temp_output) {
          Write-Host "Cleaning old temp directory..."
          Remove-Item -Recurse -Force $temp_output
        }
        if (Test-Path $output_directory) {
          Write-Host "Cleaning old output directory..."
          Remove-Item -Recurse -Force $output_directory
        }
        
        # Create output directories
        New-Item -ItemType Directory -Force -Path $base_out | Out-Null
        New-Item -ItemType Directory -Force -Path $temp_output | Out-Null
        New-Item -ItemType Directory -Force -Path $output_directory | Out-Null
        
        # Export output directories for later steps
        echo "OUTPUT_DIR=$output_directory" >> $env:GITHUB_ENV
        echo "TEMP_OUTPUT=$temp_output" >> $env:GITHUB_ENV
        
        # Execute BuildPlugin command
        $pluginPath = $env:PLUGIN_FILE
        $packagePath = $temp_output
        $buildArgs = @(
          "BuildPlugin",
          "-Plugin=$pluginPath",
          "-Package=$packagePath",
          "-CreateSubFolder",
          "-NoHostProject",
          "-Rocket"
        )
        
        Write-Host ""
        Write-Host "Starting build..." -ForegroundColor Yellow
        & "${{ env.RUNUAT_PATH }}" @buildArgs
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Build failed with exit code: $LASTEXITCODE"
          exit $LASTEXITCODE
        }
        
        $build_duration = (Get-Date) - $build_start
        $duration_str = "{0:N0}m {1:N0}s" -f $build_duration.TotalMinutes, $build_duration.Seconds
        Write-Host ""
        Write-Host "[OK] Build completed in: $duration_str" -ForegroundColor Green
        
        echo "BUILD_DURATION=$duration_str" >> $env:GITHUB_ENV

    - name: Post-Process and Optimize Package
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "==> Post-Process and Optimize Package" -ForegroundColor Cyan
        
        $temp_output = "${{ env.TEMP_OUTPUT }}"
        $output_directory = "${{ env.OUTPUT_DIR }}"
        
        # Find packaged plugin directory (BuildPlugin may create subdirectory)
        $packaged_plugin_path = $temp_output
        $plugin_subdirs = Get-ChildItem -Path $temp_output -Directory -ErrorAction SilentlyContinue
        if ($plugin_subdirs.Count -eq 1) {
          $packaged_plugin_path = $plugin_subdirs[0].FullName
          Write-Host "Detected subdirectory: $($plugin_subdirs[0].Name)"
        }
        
        if (-not (Test-Path $packaged_plugin_path)) {
          throw "Packaged plugin directory not found: $packaged_plugin_path"
        }
        
        # Copy all files to final output directory
        Write-Host "Copying files to output directory..."
        Copy-Item -Path "$packaged_plugin_path\*" -Destination $output_directory -Recurse -Force
        
        # Optimization 1: Remove Intermediate folder
        $intermediate_path = Join-Path $output_directory "Intermediate"
        if (Test-Path $intermediate_path) {
          $size_before = (Get-ChildItem $intermediate_path -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
          Remove-Item -Recurse -Force $intermediate_path
          Write-Host "[OK] Removed Intermediate folder (saved $([math]::Round($size_before, 2)) MB)"
        }
        
        # Optimization 2: Remove PDB files from all platforms
        $binaries_path = Join-Path $output_directory "Binaries"
        if (Test-Path $binaries_path) {
          $pdb_files = Get-ChildItem -Path $binaries_path -Filter "*.pdb" -Recurse -ErrorAction SilentlyContinue
          if ($pdb_files) {
            $pdb_size = ($pdb_files | Measure-Object -Property Length -Sum).Sum / 1MB
            Remove-Item -Force $pdb_files.FullName
            Write-Host "[OK] Removed PDB files (saved $([math]::Round($pdb_size, 2)) MB)"
          }
        }
        
        # Optimization 3: Remove static lib and export files
        if (Test-Path $binaries_path) {
          $lib_files = Get-ChildItem -Path $binaries_path -Include "*.lib","*.exp" -Recurse -ErrorAction SilentlyContinue
          if ($lib_files) {
            $lib_size = ($lib_files | Measure-Object -Property Length -Sum).Sum / 1MB
            Remove-Item -Force $lib_files.FullName
            Write-Host "[OK] Removed lib/exp files (saved $([math]::Round($lib_size, 2)) MB)"
          }
        }
        
        # Calculate final package size
        $final_size = (Get-ChildItem $output_directory -Recurse | Measure-Object -Property Length -Sum).Sum / 1MB
        Write-Host ""
        Write-Host "[OK] Optimization completed, final size: $([math]::Round($final_size, 2)) MB" -ForegroundColor Green
        
        echo "PACKAGE_SIZE_MB=$([math]::Round($final_size, 2))" >> $env:GITHUB_ENV
        
        # Remove temporary build directory
        if (Test-Path $temp_output) {
          Remove-Item -Recurse -Force $temp_output
        }

    - name: Prepare Artifact Name and Validate
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "==> Prepare Artifact and Validate" -ForegroundColor Cyan
        
        # Get version tag
        $repo = "${{ github.workspace }}"
        & git config --global --add safe.directory $repo 2>$null | Out-Null
        $tag = ""
        try {
          $tag = & git -C $repo describe --tags --abbrev=0 2>$null
        } catch {}
        if ([string]::IsNullOrWhiteSpace($tag)) {
          $commit = "${{ github.sha }}"
          $tag = $commit.Substring(0,7)
        }
        $artifact_name = "XTools-UE_${{ env.UE_VERSION }}-$tag"
        
        echo "VERSION_TAG=$tag" >> $env:GITHUB_ENV
        echo "ARTIFACT_NAME=$artifact_name" >> $env:GITHUB_ENV
        
        # Validate build output
        $output_path = "${{ env.OUTPUT_DIR }}"
        if (-not (Test-Path $output_path)) {
          throw "Output directory not found: $output_path"
        }
        
        # Validate key files
        $uplugin_file = Get-ChildItem -Path $output_path -Filter "*.uplugin" -Recurse
        if (-not $uplugin_file) {
          throw "Plugin .uplugin file not found"
        }
        Write-Host "[OK] Found plugin file: $($uplugin_file.Name)"
        
        # Validate Binaries directory
        $binaries_path = Join-Path $output_path "Binaries"
        if (Test-Path $binaries_path) {
          $dll_count = (Get-ChildItem -Path $binaries_path -Filter "*.dll" -Recurse).Count
          Write-Host "[OK] Found $dll_count binary files"
        }
        
        Write-Host ""
        Write-Host "[OK] Validation passed" -ForegroundColor Green

    - name: Generate Job Summary
      if: always()
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        $trigger_info = ""
        if ("${{ github.event_name }}" -eq "workflow_dispatch") {
          $selected_version = "${{ github.event.inputs.ue_version }}"
          $trigger_info = "- **Trigger**: Manual (Selected: $selected_version)`n"
        } else {
          $trigger_info = "- **Trigger**: Tag push`n"
        }
        
        $summary = @"
        ## Build Completed - UE ${{ env.UE_VERSION }}
        
        ### Build Information
        $trigger_info- **Version**: ${{ env.VERSION_TAG }}
        - **UE Version**: ${{ env.UE_VERSION }}
        - **Build Duration**: ${{ env.BUILD_DURATION }}
        - **Package Size**: ${{ env.PACKAGE_SIZE_MB }} MB
        - **Artifact Name**: ``${{ env.ARTIFACT_NAME }}``
        
        ### Build Status
        - [OK] Compilation successful
        - [OK] Post-processing completed
        - [OK] Validation passed
        
        ### Download
        Artifact uploaded to Actions Artifacts, retained for 30 days.
        "@
        
        $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8

    - name: Upload Distribution Package
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.ARTIFACT_NAME }}
        path: ${{ env.OUTPUT_DIR }}
        retention-days: 30
        compression-level: 9
        if-no-files-found: error

    - name: Cleanup Temporary Files
      if: always()
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        Write-Host "==> Cleanup Temporary Files" -ForegroundColor Cyan
        
        # Clean build directory in RUNNER_TEMP
        $base_out = Join-Path $env:RUNNER_TEMP "XTools"
        if (Test-Path $base_out) {
          try {
            $size = (Get-ChildItem $base_out -Recurse -ErrorAction SilentlyContinue | Measure-Object -Property Length -Sum).Sum / 1MB
            Remove-Item -Recurse -Force $base_out -ErrorAction Stop
            Write-Host "[OK] Cleanup completed, freed $([math]::Round($size, 2)) MB" -ForegroundColor Green
          } catch {
            Write-Warning "Cleanup failed: $_"
          }
        }

  # 创建GitHub Release（仅在tag push时触发）
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-windows-optimized
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get tag and version info
        id: version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "### 🏷️ Version: $TAG_NAME" >> $GITHUB_STEP_SUMMARY
      
      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.tag_name }}"
          
          # 从CHANGELOG.md提取当前版本的更新说明
          awk -v version="$VERSION" '
            BEGIN { found=0; content="" }
            /^## 📌 版本/ {
              if (found) exit
              if ($0 ~ version) { found=1; next }
            }
            found && /^## 📌 版本/ { exit }
            found && /^---$/ { exit }
            found { 
              # 移除标题中的 ### 保留内容
              gsub(/^### /, "## ", $0)
              gsub(/^#### /, "### ", $0)
              content = content $0 "\n" 
            }
            END { 
              if (content == "") {
                print "## Release " version "\n\n请查看 [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/Docs/CHANGELOG.md) 获取详细更新说明。"
              } else {
                print content
              }
            }
          ' Docs/CHANGELOG.md > release_notes.md
          
          echo "### 📝 Release Notes Preview" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -n 20 release_notes.md >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare release assets
        id: assets
        run: |
          mkdir -p release-assets
          
          # 复制所有zip文件到release目录
          find artifacts -type f -name "*.zip" -exec cp {} release-assets/ \;
          
          # 统计信息
          ASSET_COUNT=$(ls -1 release-assets/*.zip 2>/dev/null | wc -l)
          echo "asset_count=$ASSET_COUNT" >> $GITHUB_OUTPUT
          
          echo "### 📦 Release Assets ($ASSET_COUNT files)" >> $GITHUB_STEP_SUMMARY
          ls -lh release-assets/*.zip 2>/dev/null | awk '{printf "- `%s` (%s)\n", $9, $5}' >> $GITHUB_STEP_SUMMARY
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: XTools ${{ steps.version.outputs.tag_name }}
          body_path: release_notes.md
          files: release-assets/*.zip
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release summary
        run: |
          echo "## ✅ Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Assets**: ${{ steps.assets.outputs.asset_count }} packages" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY

