name: Build XTools Plugin (Optimized BuildPlugin)

on:
  workflow_dispatch:
    inputs:
      ue_version:
        description: 'UE Version to build for'
        required: true
        default: '5.3'
        type: choice
        options:
        - '5.3'
        - '5.4'
        - '5.5'
        - '5.6'
      
jobs:
  build-windows-optimized:
    runs-on: self-hosted
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Setup UE Environment
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        # 设置PowerShell编码 - 确保中文正确显示（须在任何输出之前）
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null  # 设置控制台代码页为UTF-8

        
        
        # UE版本检测 - 支持多版本
        $ue_version = "${{ github.event.inputs.ue_version }}"
        if (-not $ue_version) { $ue_version = "5.3" }
        
        
        
        # UE安装路径检测 (多盘符支持)
        $ue_paths = @(
          "F:\Epic Games\UE_$ue_version",
          "D:\Program Files\Epic Games\UE_$ue_version", 
          "C:\Program Files\Epic Games\UE_$ue_version",
          "E:\Epic Games\UE_$ue_version"
        )
        
        $ue_path = $null
        foreach ($path in $ue_paths) {
          
          if (Test-Path $path) {
            $ue_path = $path
            
            break
          } else {
            
          }
        }
        
        if (-not $ue_path) {
          throw ("UE install not found for version " + $ue_version + ". Checked: " + ($ue_paths -join ', '))
        }
        
        # 验证关键文件
        $runuat_path = "$ue_path\Engine\Build\BatchFiles\RunUAT.bat"
        $ue_editor_path = "$ue_path\Engine\Binaries\Win64\UnrealEditor.exe"
        
        if (-not (Test-Path $runuat_path)) {
          throw ("RunUAT.bat not found: " + $runuat_path)
        }
        
        if (-not (Test-Path $ue_editor_path)) {
          throw ("UnrealEditor.exe not found: " + $ue_editor_path)
        }
        
        # 验证插件文件
        $plugin_file = "${{ github.workspace }}\XTools.uplugin"
        if (-not (Test-Path $plugin_file)) {
          throw ("Plugin file not found: " + $plugin_file)
        }
        
        # 设置环境变量
        echo "UE_PATH=$ue_path" >> $env:GITHUB_ENV
        echo "UE_VERSION=$ue_version" >> $env:GITHUB_ENV
        echo "RUNUAT_PATH=$runuat_path" >> $env:GITHUB_ENV
        echo "UE_EDITOR_PATH=$ue_editor_path" >> $env:GITHUB_ENV
        echo "PLUGIN_FILE=$plugin_file" >> $env:GITHUB_ENV
        
        

    - name: Build Plugin with BuildPlugin Command
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        # 设置PowerShell编码 - 确保中文正确显示
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null
        
        
        
        # 输出目录设置（使用 RUNNER_TEMP，避免写入仓库目录）
        $base_out = Join-Path $env:RUNNER_TEMP "XTools"
        $output_directory = Join-Path $base_out ("XTools-UE_" + $env:UE_VERSION + "-AllPlatforms")
        $temp_output = Join-Path $base_out "TempPackage"
        
        
        
        # 清理旧的输出目录
        if (Test-Path $temp_output) { Remove-Item -Recurse -Force $temp_output }
        if (Test-Path $output_directory) { Remove-Item -Recurse -Force $output_directory }
        
        # 创建输出目录
        New-Item -ItemType Directory -Force -Path $base_out | Out-Null
        New-Item -ItemType Directory -Force -Path $temp_output | Out-Null
        New-Item -ItemType Directory -Force -Path $output_directory | Out-Null

        # 暴露输出目录供后续步骤使用
        echo ("OUTPUT_DIR=" + $output_directory) >> $env:GITHUB_ENV
        
        
        
        # 执行BuildPlugin命令 - 使用与本地脚本相同的优化参数（避免嵌套引号）
        $pluginPath  = $env:PLUGIN_FILE
        $packagePath = $temp_output
        $buildArgs = @(
          "BuildPlugin",
          "-Plugin=$pluginPath",
          "-Package=$packagePath",
          "-CreateSubFolder",
          "-NoHostProject",
          "-Rocket"
        )
        
        
        
        & "${{ env.RUNUAT_PATH }}" @buildArgs
        
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
        
        

    - name: Post-Process and Optimize Package
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        # 设置PowerShell编码 - 确保中文正确显示
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null
        
        
        
        $base_out = Join-Path $env:RUNNER_TEMP "XTools"
        $temp_output = Join-Path $base_out "TempPackage"
        $output_directory = "${{ env.OUTPUT_DIR }}"
        
        # 查找打包后的插件目录 (BuildPlugin可能创建子目录)
        $packaged_plugin_path = $temp_output
        $plugin_subdirs = Get-ChildItem -Path $temp_output -Directory
        if ($plugin_subdirs.Count -eq 1) {
          $packaged_plugin_path = $plugin_subdirs[0].FullName
          
        }
        
        if (-not (Test-Path $packaged_plugin_path)) {
          throw ("Packaged plugin directory not found: " + $packaged_plugin_path)
        }
        
        
        
        # 复制所有文件到最终输出目录
        
        Copy-Item -Path "$packaged_plugin_path\*" -Destination $output_directory -Recurse -Force
        
        # 1. 删除 Intermediate 文件夹
        $intermediate_path = Join-Path $output_directory "Intermediate"
        if (Test-Path $intermediate_path) {
          
          Remove-Item -Recurse -Force $intermediate_path
          
        } else {
          
        }
        
        # 2. 删除所有平台的 PDB 文件
        $binaries_path = Join-Path $output_directory "Binaries"
        if (Test-Path $binaries_path) {
          $pdb_files = Get-ChildItem -Path $binaries_path -Filter "*.pdb" -Recurse
          if ($pdb_files) {
            
            Remove-Item -Force $pdb_files.FullName
            
          } else {
            
          }
        }
        
        # 3. 删除临时构建目录
        
        Remove-Item -Recurse -Force $temp_output
        
        

    - name: Create Distribution Package
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        # 设置PowerShell编码 - 确保中文正确显示
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null
        
        
        
        $output_directory = "${{ env.OUTPUT_DIR }}"
        $zip_filename = "XTools-UE_${{ env.UE_VERSION }}-AllPlatforms.zip"
        $zip_filepath = Join-Path $env:RUNNER_TEMP $zip_filename
        
        if (Test-Path $zip_filepath) {
          
          Remove-Item -Force $zip_filepath
        }
        
        
        Compress-Archive -Path "$output_directory\*" -DestinationPath $zip_filepath
        
        $zip_size = [math]::Round((Get-Item $zip_filepath).Length / 1MB, 2)
        
        
        # 设置环境变量供后续步骤使用
        echo "ZIP_FILE_PATH=$zip_filepath" >> $env:GITHUB_ENV
        echo "ZIP_FILE_NAME=$zip_filename" >> $env:GITHUB_ENV

    - name: Validate Build Output
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        # 设置PowerShell编码 - 确保中文正确显示
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null
        
        
        
        $output_path = "${{ env.OUTPUT_DIR }}"
        
        if (-not (Test-Path $output_path)) { throw ("Output directory not found: " + $output_path) }
        
        # 验证关键文件（最小化校验）
        $uplugin_file = Get-ChildItem -Path $output_path -Filter "*.uplugin" -Recurse
        if (-not $uplugin_file) { throw "Plugin .uplugin not found" }
        
        # 跳过平台二进制文件详细校验（最小化验证）
        
        

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: XTools-UE_${{ env.UE_VERSION }}-AllPlatforms
        path: ${{ env.OUTPUT_DIR }}
        retention-days: 30

    - name: Upload Distribution Package
      uses: actions/upload-artifact@v4
      with:
        name: XTools-UE_${{ env.UE_VERSION }}-Distribution
        path: ${{ env.ZIP_FILE_PATH }}
        retention-days: 30

  # 构建总结
  build-summary:
    if: always()
    needs: [build-windows-optimized]
    runs-on: self-hosted
    
    steps:
    - name: Generate Build Summary
      shell: powershell -ExecutionPolicy Bypass -File {0}
      run: |
        # 设置PowerShell编码 - 确保中文正确显示
        [Console]::OutputEncoding = [System.Text.Encoding]::UTF8
        [Console]::InputEncoding = [System.Text.Encoding]::UTF8
        $OutputEncoding = [System.Text.Encoding]::UTF8
        chcp 65001 | Out-Null
        
        
        
        $build_result = "${{ needs.build-windows-optimized.result }}"
        $ue_version = "${{ github.event.inputs.ue_version }}"
        if (-not $ue_version) { $ue_version = "5.3" }
        
        echo "## XTools 插件构建总结 (优化版)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**构建时间:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" >> $GITHUB_STEP_SUMMARY
        echo "**提交哈希:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**分支:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**UE版本:** $ue_version" >> $GITHUB_STEP_SUMMARY
        echo "**构建方法:** RunUAT BuildPlugin (优化参数)" >> $GITHUB_STEP_SUMMARY
        echo "**运行器:** Self-Hosted" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if ($build_result -eq "success") {
          echo "### ✅ 构建成功" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**构建特性:**" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 多平台支持 (Windows + Linux + Mac)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 优化构建参数 (-NoHostProject -Rocket)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 自动清理临时文件 (Intermediate, PDB)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ 创建分发包 (ZIP)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**构建产物:**" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 插件文件夹: \`XTools-UE_$ue_version-AllPlatforms\`" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 分发包: \`XTools-UE_$ue_version-Distribution\`" >> $GITHUB_STEP_SUMMARY
          echo "- 📅 保留时间: 30天" >> $GITHUB_STEP_SUMMARY
        } else {
          echo "### ❌ 构建失败" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**故障排除:**" >> $GITHUB_STEP_SUMMARY
          echo "- 检查UE安装路径是否正确" >> $GITHUB_STEP_SUMMARY
          echo "- 检查插件源代码是否有编译错误" >> $GITHUB_STEP_SUMMARY
          echo "- 查看详细构建日志获取错误信息" >> $GITHUB_STEP_SUMMARY
        }
        
        
