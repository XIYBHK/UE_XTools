name: ÊâãÂä®ÂàõÂª∫ÂèëË°åÁâà

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ÁâàÊú¨Âè∑ÔºàÂ¶Ç v1.9.3Ôºâ'
        required: true
        type: string
      prerelease:
        description: 'È¢ÑÂèëÂ∏ÉÁâàÊú¨'
        required: false
        type: boolean
        default: false

# ÈªòËÆ§ÊùÉÈôêÔºöÂè™ËØªÔºàÈÅµÂæ™ÊúÄÂ∞èÊùÉÈôêÂéüÂàôÔºâ
permissions:
  contents: read

jobs:
  create-release:
    runs-on: [self-hosted, Windows]  # ‰ΩøÁî®Ëá™ÊâòÁÆ°Êú∫Âô®‰ºòÂÖà‰ªéÊú¨Âú∞ËØªÂèñ
    timeout-minutes: 30  # Èò≤Ê≠¢Â∑•‰ΩúÊµÅÊåÇËµ∑

    # Âπ∂ÂèëÊéßÂà∂ÔºöÂêå‰∏ÄÊó∂Èó¥Âè™ËÉΩÂàõÂª∫/Êõ¥Êñ∞‰∏Ä‰∏™ Release
    concurrency:
      group: release-${{ inputs.tag_name }}
      cancel-in-progress: false  # ‰∏çÂèñÊ∂àËøõË°å‰∏≠ÁöÑ Release Êìç‰Ωú

    # ÊúÄÂ∞èÊùÉÈôêÔºö‰ªÖÈúÄË¶ÅÂøÖË¶ÅÁöÑÊùÉÈôê
    permissions:
      contents: write  # ÂàõÂª∫ Release„ÄÅÂàõÂª∫ Tag„ÄÅ‰∏ä‰º†ËµÑ‰∫ß
      actions: read    # ‰∏ãËΩΩÊûÑÂª∫‰∫ßÁâ©

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        id: validate
        shell: pwsh -ExecutionPolicy Bypass -File {0}
        run: |
          $TAG_NAME = "${{ inputs.tag_name }}"
          $RELEASE_NAME = $TAG_NAME

          "tag_name=$TAG_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "release_name=$RELEASE_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          # Ê£ÄÊü• tag ÊòØÂê¶Â∑≤Â≠òÂú®
          $tagExists = git rev-parse $TAG_NAME 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "::warning::Tag $TAG_NAME already exists locally"
            "tag_exists=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "tag_exists=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Extract changelog
        id: changelog
        shell: pwsh -ExecutionPolicy Bypass -File {0}
        run: |
          $VERSION = "${{ steps.validate.outputs.tag_name }}"
          $changelog_path = "Docs\ÁâàÊú¨ÂèòÊõ¥\CHANGELOG.md"
          $release_notes_path = "release_notes.md"

          # ‰ªéCHANGELOG.mdÊèêÂèñÂΩìÂâçÁâàÊú¨ÁöÑÊõ¥Êñ∞ËØ¥Êòé
          if (Test-Path $changelog_path) {
            $content = Get-Content $changelog_path -Raw -Encoding UTF8
            $lines = $content -split "`n"

            $found = $false
            $release_content = @()

            foreach ($line in $lines) {
              if ($line -match "^## ÁâàÊú¨.*$VERSION") {
                $found = $true
                continue
              }

              if ($found) {
                if ($line -match "^## ÁâàÊú¨" -or $line -match "^---") {
                  break
                }
                $release_content += $line
              }
            }

            if ($release_content.Count -gt 0) {
              $release_content | Out-File -FilePath $release_notes_path -Encoding utf8
            } else {
              "## Release $VERSION`n`nËØ∑Êü•Áúã [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/Docs/ÁâàÊú¨ÂèòÊõ¥/CHANGELOG.md) Ëé∑ÂèñËØ¶ÁªÜÊõ¥Êñ∞ËØ¥Êòé„ÄÇ" |
                Out-File -FilePath $release_notes_path -Encoding utf8
            }
          } else {
            "## Release $VERSION`n`nÊâãÂä®ÂàõÂª∫ÁöÑÂèëÂ∏ÉÁâàÊú¨„ÄÇ" | Out-File -FilePath $release_notes_path -Encoding utf8
          }

          # È¢ÑËßà
          "### üìù Release Notes Preview" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          Get-Content $release_notes_path -Head 30 | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "``````" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

      - name: Get artifacts (local first, fallback to download)
        id: get_artifacts
        shell: pwsh -ExecutionPolicy Bypass -File {0}
        run: |
          Write-Host "==> Get Release Assets" -ForegroundColor Cyan

          $release_assets_dir = ".\release-assets"
          $local_temp_dir = "C:\GitHubActions\ReleaseTemp"

          # ÂàõÂª∫ËµÑ‰∫ßÁõÆÂΩï
          New-Item -ItemType Directory -Path $release_assets_dir -Force | Out-Null

          # ‰ºòÂÖà‰ªéÊú¨Âú∞‰∏¥Êó∂ÁõÆÂΩïËØªÂèñ
          if (Test-Path $local_temp_dir) {
            $local_files = Get-ChildItem -Path $local_temp_dir -Filter "*.zip" -ErrorAction SilentlyContinue

            if ($local_files.Count -gt 0) {
              Write-Host "[Êú¨Âú∞ËØªÂèñ] ‰ªéÊú¨Âú∞‰∏¥Êó∂ÁõÆÂΩïÂ§çÂà∂ $($local_files.Count) ‰∏™Êñá‰ª∂" -ForegroundColor Green

              foreach ($file in $local_files) {
                Write-Host "  - $($file.Name)"
                Copy-Item $file.FullName -Destination $release_assets_dir -Force
              }

              "source=local" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
              "asset_count=$($local_files.Count)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
              exit 0
            }
          }

          Write-Host "[ÂõûÈÄÄ] Êú¨Âú∞Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÂ∞Ü‰ªé Artifacts ‰∏ãËΩΩ" -ForegroundColor Yellow
          "source=download" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Download from Artifacts (fallback)
        if: steps.get_artifacts.outputs.source == 'download'
        uses: actions/github-script@v7
        continue-on-error: false
        with:
          retries: 3
          script: |
            const { execSync } = require('child_process');
            const fs = require('fs');
            const path = require('path');

            // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÊàêÂäüÊûÑÂª∫
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-plugin-optimized.yml',
              status: 'success',
              per_page: 1
            });

            if (runs.data.workflow_runs.length === 0) {
              throw new Error('No successful builds found');
            }

            const runId = runs.data.workflow_runs[0].id;
            console.log(`Downloading from run #${runs.data.workflow_runs[0].run_number} (ID: ${runId})`);

            // ‰∏ãËΩΩÊâÄÊúâ artifacts
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: runId
            });

            const releaseDir = 'release-assets';
            const tempDir = 'temp-download';

            if (!fs.existsSync(tempDir)) {
              fs.mkdirSync(tempDir, { recursive: true });
            }

            let downloadCount = 0;

            for (const artifact of artifacts.data.artifacts) {
              if (artifact.name.includes('XTools-UE_')) {
                console.log(`\n[${downloadCount}] Downloading: ${artifact.name}`);

                // ‰∏ãËΩΩ ArtifactÔºà‰ºöÂæóÂà∞Â§ñÂ±Ç ZIPÔºâ
                const download = await github.rest.actions.downloadArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_id: artifact.id,
                  archive_format: 'zip'
                });

                // ‰øùÂ≠òÂ§ñÂ±Ç ZIP
                const tempZipPath = path.join(tempDir, `${artifact.name}-outer.zip`);
                fs.writeFileSync(tempZipPath, Buffer.from(download.data));
                console.log(`  Saved outer ZIP: ${tempZipPath}`);

                // Ëß£ÂéãÂ§ñÂ±Ç ZIPÔºåÊèêÂèñÂÜÖÈÉ®ÁöÑÂéüÂßã ZIP Êñá‰ª∂
                try {
                  const extractedDir = path.join(tempDir, artifact.name);
                  execSync(`pwsh -Command "Expand-Archive -Path '${tempZipPath}' -DestinationPath '${extractedDir}' -Force"`, { stdio: 'inherit' });

                  // Êü•ÊâæÂÜÖÈÉ®ÁöÑ .zip Êñá‰ª∂
                  const innerZips = fs.readdirSync(extractedDir).filter(f => f.endsWith('.zip'));

                  if (innerZips.length > 0) {
                    // ÁßªÂä®ÂÜÖÈÉ® ZIP Âà∞ÂèëÂ∏ÉÁõÆÂΩï
                    const innerZipPath = path.join(extractedDir, innerZips[0]);
                    const destPath = path.join(releaseDir, innerZips[0]);
                    fs.copyFileSync(innerZipPath, destPath);
                    console.log(`  ‚úì Extracted: ${innerZips[0]}`);
                    downloadCount++;
                  } else {
                    console.log(`  ‚ö† No inner ZIP found, artifact may not be nested`);
                  }
                } catch (error) {
                  console.error(`  ‚úó Failed to extract: ${error.message}`);
                }
              }
            }

            // Ê∏ÖÁêÜ‰∏¥Êó∂ÁõÆÂΩï
            if (fs.existsSync(tempDir)) {
              fs.rmSync(tempDir, { recursive: true, force: true });
            }

            console.log(`\n‚úì Downloaded and extracted ${downloadCount} files`);

      - name: List release assets
        shell: pwsh -ExecutionPolicy Bypass -File {0}
        run: |
          if (Test-Path "release-assets") {
            "### üì¶ Release Assets" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append

            $files = Get-ChildItem -Path "release-assets" -Filter "*.zip" -ErrorAction SilentlyContinue
            if ($files) {
              foreach ($file in $files) {
                $size_mb = [math]::Round($file.Length / 1MB, 2)
                "- ``$($file.Name)`` ($size_mb MB)" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
              }
            }
          } else {
            "### ‚ö†Ô∏è No assets found" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }

      - name: Create tag if not exists
        if: steps.validate.outputs.tag_exists == 'false'
        shell: pwsh -ExecutionPolicy Bypass -File {0}
        run: |
          $TAG_NAME = "${{ steps.validate.outputs.tag_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a $TAG_NAME -m "Release $TAG_NAME"
          git push origin $TAG_NAME

      - name: Check if Release exists
        id: check_release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = '${{ steps.validate.outputs.tag_name }}';

            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });

              console.log(`Release ${tagName} already exists (ID: ${release.data.id})`);
              core.setOutput('exists', 'true');
              core.setOutput('release_id', String(release.data.id));
              core.setOutput('html_url', release.data.html_url);
            } catch (error) {
              if (error.status === 404) {
                console.log(`Release ${tagName} does not exist, will create new one`);
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }

      - name: Create or Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.validate.outputs.tag_name }}
          name: ${{ steps.validate.outputs.release_name }}
          body_path: release_notes.md
          files: release-assets/*.zip
          prerelease: ${{ inputs.prerelease }}
          fail_on_unmatched_files: false
          # Â¶ÇÊûú Release Â∑≤Â≠òÂú®Ôºåsoftprops/action-gh-release ‰ºöËá™Âä®Êõ¥Êñ∞

      - name: Summary
        shell: pwsh -ExecutionPolicy Bypass -File {0}
        run: |
          if ("${{ steps.check_release.outputs.exists }}" -eq "true") {
            "### ‚úÖ Release Updated Successfully" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
            "> ‚ÑπÔ∏è Release already existed, assets have been updated" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          } else {
            "### ‚úÖ Release Created Successfully" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          }
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "- **Tag**: ${{ steps.validate.outputs.tag_name }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "- **Name**: ${{ steps.validate.outputs.release_name }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "- **Pre-release**: ${{ inputs.prerelease }}" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append
          "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.validate.outputs.tag_name }})" | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding utf8 -Append