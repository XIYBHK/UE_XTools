name: æ‰‹åŠ¨åˆ›å»ºå‘è¡Œç‰ˆ

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¦‚ v1.9.3ï¼‰'
        required: true
        type: string
      prerelease:
        description: 'é¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false

# é»˜è®¤æƒé™ï¼šåªè¯»ï¼ˆéµå¾ªæœ€å°æƒé™åŽŸåˆ™ï¼‰
permissions:
  contents: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # é˜²æ­¢å·¥ä½œæµæŒ‚èµ·

    # å¹¶å‘æŽ§åˆ¶ï¼šåŒä¸€æ—¶é—´åªèƒ½åˆ›å»º/æ›´æ–°ä¸€ä¸ª Release
    concurrency:
      group: release-${{ inputs.tag_name }}
      cancel-in-progress: false  # ä¸å–æ¶ˆè¿›è¡Œä¸­çš„ Release æ“ä½œ

    # æœ€å°æƒé™ï¼šä»…éœ€è¦å¿…è¦çš„æƒé™
    permissions:
      contents: write  # åˆ›å»º Releaseã€åˆ›å»º Tagã€ä¸Šä¼ èµ„äº§
      actions: read    # ä¸‹è½½æž„å»ºäº§ç‰©

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate inputs
        id: validate
        run: |
          TAG_NAME="${{ inputs.tag_name }}"
          RELEASE_NAME="$TAG_NAME"

          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT

          # æ£€æŸ¥ tag æ˜¯å¦å·²å­˜åœ¨
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "::warning::Tag $TAG_NAME already exists locally"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog
        id: changelog
        run: |
          VERSION="${{ steps.validate.outputs.tag_name }}"

          # ä»ŽCHANGELOG.mdæå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°è¯´æ˜Ž
          if [ -f "Docs/ç‰ˆæœ¬å˜æ›´/CHANGELOG.md" ]; then
            awk -v version="$VERSION" '
              BEGIN { found=0; content="" }
              /^## ç‰ˆæœ¬/ {
                if (found) exit
                if ($0 ~ version) { found=1; next }
              }
              found && /^## ç‰ˆæœ¬/ { exit }
              found && /^---$/ { exit }
              found {
                content = content $0 "\n"
              }
              END {
                if (content == "") {
                  print "## Release " version "\n\nè¯·æŸ¥çœ‹ [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/Docs/ç‰ˆæœ¬å˜æ›´/CHANGELOG.md) èŽ·å–è¯¦ç»†æ›´æ–°è¯´æ˜Žã€‚"
                } else {
                  print content
                }
              }
            ' Docs/ç‰ˆæœ¬å˜æ›´/CHANGELOG.md > release_notes.md
          else
            echo "## Release $VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "æ‰‹åŠ¨åˆ›å»ºçš„å‘å¸ƒç‰ˆæœ¬ã€‚" >> release_notes.md
          fi

          echo "### ðŸ“ Release Notes Preview" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          head -n 30 release_notes.md >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Get artifacts from latest build
        id: get_artifacts
        uses: actions/github-script@v7
        continue-on-error: false  # ä¸‹è½½å¤±è´¥åº”åœæ­¢æµç¨‹
        with:
          retries: 3  # GitHub API å¯èƒ½ä¸ç¨³å®šï¼Œé‡è¯•3æ¬¡
          script: |
            // å§‹ç»ˆèŽ·å–æœ€æ–°çš„æˆåŠŸæž„å»º
            const runs = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build-plugin-optimized.yml',
              status: 'success',
              per_page: 1
            });

            let runId = null;
            if (runs.data.workflow_runs.length > 0) {
              runId = runs.data.workflow_runs[0].id;
              console.log(`Using artifacts from run #${runs.data.workflow_runs[0].run_number} (ID: ${runId})`);
            }

            if (runId) {
              // ä¸‹è½½æ‰€æœ‰ artifacts
              const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: runId
              });

              console.log(`Found ${artifacts.data.artifacts.length} artifacts`);

              const fs = require('fs');
              const path = require('path');

              // åˆ›å»ºç›®å½•
              const dir = 'release-assets';
              if (!fs.existsSync(dir)) {
                fs.mkdirSync(dir, { recursive: true });
              }

              // ä¸‹è½½æ¯ä¸ª artifact
              for (const artifact of artifacts.data.artifacts) {
                if (artifact.name.includes('XTools-UE_')) {
                  console.log(`Downloading ${artifact.name}...`);

                  const download = await github.rest.actions.downloadArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id,
                    archive_format: 'zip'
                  });

                  const filePath = path.join(dir, `${artifact.name}.zip`);
                  fs.writeFileSync(filePath, Buffer.from(download.data));
                  console.log(`Saved to ${filePath}`);
                }
              }

              return runId;
            }

            return null;

      - name: List release assets
        run: |
          if [ -d "release-assets" ]; then
            echo "### ðŸ“¦ Release Assets" >> $GITHUB_STEP_SUMMARY
            ls -lh release-assets/*.zip 2>/dev/null | while read -r line; do
              echo "- ${line}" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "### âš ï¸ No assets found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Create tag if not exists
        if: steps.validate.outputs.tag_exists == 'false'
        run: |
          TAG_NAME="${{ steps.validate.outputs.tag_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

      - name: Check if Release exists
        id: check_release
        uses: actions/github-script@v7
        with:
          script: |
            const tagName = '${{ steps.validate.outputs.tag_name }}';

            try {
              const release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });

              console.log(`Release ${tagName} already exists (ID: ${release.data.id})`);
              core.setOutput('exists', 'true');
              core.setOutput('release_id', String(release.data.id));
              core.setOutput('html_url', release.data.html_url);
            } catch (error) {
              if (error.status === 404) {
                console.log(`Release ${tagName} does not exist, will create new one`);
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }

      - name: Create or Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.validate.outputs.tag_name }}
          name: ${{ steps.validate.outputs.release_name }}
          body_path: release_notes.md
          files: release-assets/*.zip
          prerelease: ${{ inputs.prerelease }}
          fail_on_unmatched_files: false
          # å¦‚æžœ Release å·²å­˜åœ¨ï¼Œsoftprops/action-gh-release ä¼šè‡ªåŠ¨æ›´æ–°

      - name: Summary
        run: |
          if [ "${{ steps.check_release.outputs.exists }}" == "true" ]; then
            echo "### âœ… Release Updated Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "> â„¹ï¸ Release already existed, assets have been updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Release Created Successfully" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ steps.validate.outputs.tag_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Name**: ${{ steps.validate.outputs.release_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.validate.outputs.tag_name }})" >> $GITHUB_STEP_SUMMARY